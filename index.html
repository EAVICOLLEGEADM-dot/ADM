<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EAVI Admission & Bursary System</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#005a9e">

        <!-- Favicon for browser tabs and bookmarks -->
    <link rel="icon" href="logo.png" type="image/png">
    <link rel="apple-touch-icon" href="images/icon-192x192.png">

    <!-- CDN Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVXM5BCClRCagvRMDCGkuVTzpbclw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        /* --- GLOBAL STYLES & RESET --- */
        :root {
            --primary-color: #005a9e;
            --secondary-color: #003d6b;
            --accent-color: #fdb813;
            --light-gray: #f4f7fa;
            --medium-gray: #e1e5e8;
            --dark-gray: #5a6772;
            --text-color: #333;
            --white: #fff;
            --danger-color: #d9534f;
            --success-color: #5cb85c;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --border-radius: 6px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            font-family: var(--font-family);
            background-color: var(--light-gray);
            color: var(--text-color);
            font-size: 16px;
            line-height: 1.6;
        }

        .hidden { display: none !important; }

        /* --- LOGIN VIEW --- */
        #loginView {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }

        .login-card {
            background: var(--white);
            padding: 2.5rem 3rem;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-card h1 {
            margin-bottom: 0.5rem;
            color: var(--secondary-color);
        }

        .login-card p {
            margin-bottom: 2rem;
            color: var(--dark-gray);
        }

        .login-card .input-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .login-card label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .login-card input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            font-size: 1rem;
        }

        #loginBtn {
            width: 100%;
            padding: 0.85rem;
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: var(--border-radius);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #loginBtn:hover {
            background-color: var(--secondary-color);
        }

        #loginError {
            color: var(--danger-color);
            margin-top: 1rem;
            min-height: 1.2em;
        }

        /* --- MAIN APP VIEW --- */
        #appView {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .navbar {
            display: flex;
            align-items: center;
            background-color: var(--white);
            padding: 0 2rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            flex-shrink: 0;
        }

        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-right: 2rem;
        }

        .nav-tabs {
            display: flex;
            flex-grow: 1;
        }

        .nav-tab {
            padding: 1rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            color: var(--dark-gray);
            font-weight: 600;
            transition: all 0.3s;
        }

        .nav-tab:hover {
            background-color: var(--light-gray);
            color: var(--primary-color);
        }

        .nav-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        #logoutBtn {
            background: none;
            border: 1px solid var(--medium-gray);
            color: var(--dark-gray);
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
        }
        #logoutBtn:hover {
            background-color: var(--danger-color);
            color: var(--white);
            border-color: var(--danger-color);
        }

        .main-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 2rem;
        }

        .view-content {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* --- UI COMPONENTS --- */
        .card {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .card-header {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--secondary-color);
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--medium-gray);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
        }
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            font-size: 1rem;
        }

        .form-group input[type="file"] {
            padding: 0.4rem;
        }

        .form-group input:read-only {
            background-color: var(--light-gray);
        }

        .btn {
            padding: 0.8rem 1.6rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.2s ease-in-out;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }

        .btn:active {
            transform: scale(0.98);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .btn:disabled,
        .btn[disabled] {
            background-color: var(--medium-gray) !important;
            color: var(--dark-gray) !important;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-primary { background: var(--primary-color); color: var(--white); }
        .btn-primary:hover { background: linear-gradient(145deg, var(--primary-color), var(--secondary-color)); }
        .btn-secondary { background: var(--dark-gray); color: var(--white); }
        .btn-secondary:hover { background: #333; }
        .btn-danger { background: var(--danger-color); color: var(--white); }
        .btn-danger:hover { background: #c9302c; }
        .btn-success { background: var(--success-color); color: var(--white); }
        .btn-success:hover { background: #449d44; }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
            text-transform: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }

        th, td {
            padding: 0.8rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--medium-gray);
        }

        th {
            background-color: var(--light-gray);
            font-weight: 700;
        }

        tbody tr:hover {
            background-color: #fdfde9;
        }

        /* --- GENERATE VIEW --- */
        #viewGenerate .grid-2 {
            grid-template-columns: 40% 1fr;
            align-items: flex-start;
        }

        .preview-container {
            background-color: var(--dark-gray);
            padding: 2rem;
            border-radius: var(--border-radius);
            height: calc(100vh - 150px);
            overflow: auto;
        }

        .preview-area {
            margin-bottom: 2rem;
        }

        .preview-area h3 {
            color: var(--white);
            margin-bottom: 1rem;
        }

        /* --- A4 PAGE RENDERING --- */
        .page {
            background: white;
            display: block;
            margin: 0 auto;
            margin-bottom: 0.5cm;
            box-shadow: 0 0 0.5cm rgba(0,0,0,0.5);
            padding: 2cm;
            color: #000;
            position: relative;
            font-size: 14px;
        }

        .page.A4 {
            width: 21cm;
            min-height: 29.7cm;
        }

        .page-header-img {
            display: block;
            width: 15cm;
            height: 4cm; /* Reduced height */
            margin: -2cm auto 1cm; /* Move to top & reduce bottom margin */
            object-fit: contain;
        }

        .letter-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1cm;
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
        }

        .letter-body {
            line-height: 1.5;
        }

        .letter-body h3 {
            text-decoration: underline;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .letter-body p, .letter-body ul {
            margin-bottom: 0.8rem;
        }

        .letter-body .details-block {
            margin: 1.5rem 0;
        }

        .letter-body .details-block span {
            font-weight: bold;
        }

        .letter-footer {
            margin-top: 1cm;
            position: relative;
        }

        .stamp-container {
            position: absolute;
            /* Adjust these values to position the entire stamp */
            top: 0; /* Moves the stamp down from "Yours faithfully," */
            right: 2cm; /* Moves the stamp from the right edge of the page */
            width: 180px;
            height: 180px;
        }

        .stamp-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .stamp-date {
            position: absolute;
            /* Adjust these values to move the date to the correct spot on your stamp image */
            top: 55%; 
            left: 50%;
            transform: translate(-50%, -50%) rotate(0deg); /* Adjust rotation if needed */
            color: #00008B; /* Dark Blue */
            font-weight: bold;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        /* --- TEMPLATE STYLES --- */
        .template-classic { font-family: 'Times New Roman', Times, serif; }
        .template-classic .page { border: 1px solid #333; }

        .template-modern { font-family: Arial, Helvetica, sans-serif; }
        .template-modern .letter-header { font-family: sans-serif; }
        .template-modern h3 { border-bottom: 2px solid var(--primary-color); text-decoration: none; padding-bottom: 5px; }

        .template-minimal { font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif; line-height: 2; }

        .template-bordered .page { border: 10px double #333; padding: 2.5cm; }

        /* --- TOAST NOTIFICATION --- */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        .toast {
            background-color: #333;
            color: #fff;
            padding: 15px 20px;
            border-radius: 5px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            transform: translateX(100%);
        }
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--danger-color); }

        /* --- UPDATE NOTIFICATION BAR --- */
        #update-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--accent-color);
            color: var(--secondary-color);
            padding: 1rem;
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            text-align: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            z-index: 10000;
        }
        #update-bar.show {
            display: flex;
        }
        #update-bar-text {
            margin-right: 1.5rem;
            font-weight: 600;
        }

        /* --- PRINT STYLES --- */
        @media print {
            body, html {
                background: #fff;
            }
            .no-print, .navbar, #viewGenerate > .grid-2 > div:first-child, .preview-container {
                display: none;
            }
            .main-content {
                padding: 0;
                overflow: visible;
            }
            .page {
                margin: 0;
                box-shadow: none;
                border: none;
                width: auto;
                min-height: auto;
                page-break-after: always;
            }
            .page:last-child {
                page-break-after: avoid;
            }
            .print-only {
                display: block !important;
            }
            #previewAdmission, #previewBursary {
                display: none;
            }
            #print-area {
                display: block !important;
            }
        }

        #print-area {
            display: none;
        }
    </style>
</head>
<body>

    <!-- Login View -->
    <div id="loginView">
        <div class="login-card">
            <h1>EAVI System</h1>
            <p>Admission & Bursary Letter Generation</p>
            <div class="input-group">
                <label for="loginUsername">Username</label>
                <input type="text" id="loginUsername" value="EAVI">
            </div>
            <div class="input-group">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" value="eavi123">
            </div>
            <button id="loginBtn">Login</button>
            <p id="loginError"></p>
        </div>
    </div>

    <!-- Main Application View -->
    <div id="appView" class="hidden">
        <nav class="navbar">
            <div class="navbar-brand">EAVI</div>
            <div class="nav-tabs">
                <div class="nav-tab active" id="tabDashboard" data-view="viewDashboard">Dashboard</div>
                <div class="nav-tab" id="tabGenerate" data-view="viewGenerate">Generate</div>
                <div class="nav-tab" id="tabStudents" data-view="viewStudents">Student List</div>
                <div class="nav-tab" id="tabAnalysis" data-view="viewAnalysis">Analysis</div>
                <div class="nav-tab" id="tabSettings" data-view="viewSettings">Settings</div>
                <div class="nav-tab" id="tabBackup" data-view="viewBackup">Backup/Restore</div>
            </div>
            <button id="logoutBtn">Logout</button>
        </nav>

        <main class="main-content">
            <!-- Dashboard View -->
            <div id="viewDashboard" class="view-content">
                <div class="card">
                    <h2 class="card-header">Dashboard</h2>
                    <p>Welcome to the EAVI Admission & Bursary System. Quick stats will be shown here.</p>
                </div>
            </div>

            <!-- Generate View -->
            <div id="viewGenerate" class="view-content hidden">
                <div class="grid-2">
                    <div>
                        <div class="card">
                            <h2 class="card-header">Student Details</h2>
                            <input type="hidden" id="currentDeptRequirements">
                            <input type="hidden" id="editingStudentId">
                            <div class="grid-2">
                                <div class="form-group">
                                    <label for="inpName">Student Full Name</label>
                                    <input type="text" id="inpName" required>
                                </div>
                                <div class="form-group">
                                    <label for="inpAdmNo">Admission Number</label>
                                    <input type="text" id="inpAdmNo" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="inpCourseType">Course Type</label>
                                <select id="inpCourseType" required>
                                    <option value="Diploma">Diploma</option>
                                    <option value="Certificate">Certificate</option>
                                    <option value="Artisan">Artisan</option>
                                </select>
                            </div>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label for="inpCourse">Course</label>
                                    <select id="inpCourse" required></select>
                                </div>
                                <div class="form-group">
                                    <label for="inpDept">Department</label>
                                    <input type="text" id="inpDept" readonly>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="inpReportDate">Reporting Date</label>
                                <input type="date" id="inpReportDate" required>
                            </div>
                            <h3 style="margin-top: 2rem; color: var(--secondary-color);">Bursary-Only Fields</h3>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label for="inpFeeBalance">Fee Balance (KES)</label>
                                    <input type="number" id="inpFeeBalance" value="0">
                                </div>
                                <div class="form-group">
                                    <label for="inpTotalPerTerm">Total Fees per Term (KES)</label>
                                    <input type="number" id="inpTotalPerTerm" value="0">
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <h2 class="card-header">Document Settings</h2>
                            <div class="form-group">
                                <label for="templateSelect">Template Style</label>
                                <select id="templateSelect">
                                    <option value="classic">Classic</option>
                                    <option value="modern">Modern</option>
                                    <option value="minimal">Minimal</option>
                                    <option value="bordered">Bordered</option>
                                </select>
                            </div>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label for="inpHeaderImage">Header Image (15cm x 6cm)</label>
                                    <input type="file" id="inpHeaderImage" accept="image/png, image/jpeg">
                                    <img id="headerPreview" style="max-width: 100px; max-height: 50px; margin-top: 10px; border: 1px solid var(--medium-gray); object-fit: contain;" class="hidden">
                                </div>
                                <div class="form-group">
                                    <label for="inpStampImage">Stamp Image (PNG)</label>
                                    <input type="file" id="inpStampImage" accept="image/png">
                                    <img id="stampPreview" style="max-width: 100px; max-height: 100px; margin-top: 10px; border: 1px solid var(--medium-gray); object-fit: contain;" class="hidden">
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <h2 class="card-header">Generate & Save</h2>
                            <p>Clicking 'Generate' will create the previews and save the student record.</p>
                            <br>
                            <div class="btn-group">
                                <button id="btnGenerate" class="btn btn-primary">Generate & Save</button>
                                <button id="btnResetForm" class="btn btn-secondary">Reset Form</button>
                            </div>
                        </div>
                    </div>

                    <div class="preview-container">
                        <div id="admissionActions" class="card hidden">
                            <h3 class="card-header">Admission Letter Actions</h3>
                            <div class="btn-group">
                                <button id="btnPrintAdmission" class="btn btn-secondary">Print</button>
                                <button id="btnPdfAdmission" class="btn btn-success">PDF</button>
                                <button id="btnShareWhatsappAdmission" class="btn btn-primary">Share WhatsApp</button>
                            </div>
                        </div>
                        <div class="preview-area" id="previewAdmission">
                            <!-- Admission letter preview will be rendered here -->
                        </div>

                        <div id="bursaryActions" class="card hidden">
                            <h3 class="card-header">Bursary Letter Actions</h3>
                            <div class="btn-group">
                                <button id="btnPrintBursary" class="btn btn-secondary">Print</button>
                                <button id="btnPdfBursary" class="btn btn-success">PDF</button>
                                <button id="btnShareWhatsappBursary" class="btn btn-primary">Share WhatsApp</button>
                            </div>
                        </div>
                        <div class="preview-area" id="previewBursary">
                            <!-- Bursary letter preview will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Student List View -->
            <div id="viewStudents" class="view-content hidden">
                <div class="card">
                    <h2 class="card-header">Student List</h2>
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="studentSearch">Search by Name or Admission No.</label>
                            <input type="text" id="studentSearch" placeholder="Start typing to search...">
                        </div>
                        <div class="form-group">
                            <label for="studentYearFilter">Filter by Year</label>
                            <select id="studentYearFilter"></select>
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table id="studentsTable">
                            <thead>
                                <tr>
                                    <th>Ref No</th>
                                    <th>Name</th>
                                    <th>Adm No</th>
                                    <th>Course</th>
                                    <th>Report Date</th>
                                    <th>Year</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Student rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Analysis View -->
            <div id="viewAnalysis" class="view-content hidden">
                <div class="card">
                    <h2 class="card-header">Analysis & Reports</h2>
                    <div class="grid-2">
                        <div class="chart-container">
                            <h3>Admissions per Year</h3>
                            <canvas id="admissionsPerYearChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>Admissions by Department</h3>
                            <canvas id="admissionsByDeptChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="viewSettings" class="view-content hidden">
                <div class="grid-2">
                    <div class="card">
                        <h2 class="card-header">Departments</h2>
                        <form id="deptForm">
                            <input type="hidden" id="editingDeptId">
                            <div class="form-group">
                                <label for="deptName">Department Name</label>
                                <input type="text" id="deptName" required>
                            </div>
                            <div class="form-group">
                                <label for="deptRequirements">Requirements (one per line)</label>
                                <textarea id="deptRequirements" rows="4"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Add Department</button>
                            <button type="button" id="cancelDeptEditBtn" class="btn btn-secondary hidden">Cancel Edit</button>
                        </form>
                        <table id="deptTable" style="margin-top: 2rem;">
                            <thead><tr><th>Name</th><th>Actions</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="card">
                        <h2 class="card-header">Courses</h2>
                        <form id="courseForm">
                            <input type="hidden" id="editingCourseId">
                            <div class="form-group">
                                <label for="courseName">Course Name</label>
                                <input type="text" id="courseName" required>
                            </div>
                            <div class="form-group">
                                <label for="courseDept">Department</label>
                                <select id="courseDept" required></select>
                            </div>
                            <button type="submit" class="btn btn-primary">Add Course</button>
                            <button type="button" id="cancelCourseEditBtn" class="btn btn-secondary hidden">Cancel Edit</button>
                        </form>
                        <table id="courseTable" style="margin-top: 2rem;">
                            <thead><tr><th>Name</th><th>Department</th><th>Actions</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Backup/Restore View -->
            <div id="viewBackup" class="view-content hidden">
                <div class="card">
                    <h2 class="card-header">Backup & Restore</h2>
                    <div class="grid-2">
                        <div>
                            <h3>Backup</h3>
                            <p>Download all application data (students, courses, settings) into a single JSON file.</p>
                            <button id="backupBtn" class="btn btn-success">Backup All Data</button>
                        </div>
                        <div>
                            <h3>Restore</h3>
                            <p>Restore data from a previously saved JSON file. <strong>Warning:</strong> This will overwrite all existing data.</p>
                            <input type="file" id="restoreFile" accept=".json">
                            <button id="restoreBtn" class="btn btn-danger" disabled>Restore from File</button>
                        </div>
                    </div>
                    <hr style="margin: 2rem 0; border-color: var(--medium-gray);">
                    <div>
                        <h3 style="color: var(--danger-color);">Danger Zone</h3>
                        <p>This action will permanently delete all students, departments, courses, and saved images. This cannot be undone.</p>
                        <br>
                        <button id="clearDataBtn" class="btn btn-danger">Clear All System Data</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <!-- Update Notification Bar -->
    <div id="update-bar">
        <span id="update-bar-text">A new version is available.</span>
        <button id="update-btn" class="btn btn-secondary">Reload</button>
    </div>

    <!-- Area for printing content -->
    <div id="print-area"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE & CONFIG ---
        const state = {
            db: null,
            headerImageDataUrl: null,
            stampImageDataUrl: null,
            currentStudentData: null,
            charts: {}
        };

        const DB_NAME = 'eaviDB';
        const DB_VERSION = 1;

        // --- DOM ELEMENTS ---
        const loginView = document.getElementById('loginView');
        const appView = document.getElementById('appView');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginUsername = document.getElementById('loginUsername');
        const loginPassword = document.getElementById('loginPassword');
        const loginError = document.getElementById('loginError');

        const tabs = document.querySelectorAll('.nav-tab');
        const views = document.querySelectorAll('.view-content');

        // Generate Form
        const generateForm = {
            id: document.getElementById('editingStudentId'),
            requirements: document.getElementById('currentDeptRequirements'),
            name: document.getElementById('inpName'),
            admNo: document.getElementById('inpAdmNo'),
            courseType: document.getElementById('inpCourseType'),
            course: document.getElementById('inpCourse'),
            dept: document.getElementById('inpDept'),
            reportDate: document.getElementById('inpReportDate'),
            feeBalance: document.getElementById('inpFeeBalance'),
            totalPerTerm: document.getElementById('inpTotalPerTerm'),
            template: document.getElementById('templateSelect'),
            headerImg: document.getElementById('inpHeaderImage'),
            stampImg: document.getElementById('inpStampImage'),
            btnGenerate: document.getElementById('btnGenerate'),
            btnReset: document.getElementById('btnResetForm'),
        };

        // Set minimum date for reporting date input to prevent past dates
        generateForm.reportDate.min = new Date().toISOString().split('T')[0];

        // Previews & Actions
        const previewAdmission = document.getElementById('previewAdmission');
        const previewBursary = document.getElementById('previewBursary');
        const admissionActions = document.getElementById('admissionActions');
        const bursaryActions = document.getElementById('bursaryActions');

        // --- INITIALIZATION ---
        function init() {
            if (sessionStorage.getItem('eaviAuth') === 'true') {
                showApp();
            } else {
                showLogin();
            }
        }

        async function showApp() {
            loginView.classList.add('hidden');
            appView.classList.remove('hidden');
            await initDB();
            await loadInitialData();
            setupEventListeners();
            navigateToView('viewDashboard');
        }

        function showLogin() {
            loginView.classList.remove('hidden');
            appView.classList.add('hidden');
            loginBtn.addEventListener('click', handleLogin, { once: true });
        }

        async function loadInitialData() {
            await loadPersistedSettings();
            await loadCoursesAndDepartments();
            await loadStudentList();
            await updateDashboard();
        }

        // --- AUTHENTICATION ---
        function handleLogin() {
            const user = loginUsername.value.trim();
            const pass = loginPassword.value.trim();
            if (user === 'EAVI' && pass === 'eavi123') {
                sessionStorage.setItem('eaviAuth', 'true');
                showApp();
            } else {
                loginError.textContent = 'Invalid username or password.';
                loginBtn.addEventListener('click', handleLogin, { once: true }); // Re-attach listener
            }
        }

        function handleLogout() {
            sessionStorage.removeItem('eaviAuth');
            window.location.reload();
        }

        // --- DATABASE (IndexedDB) ---
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = (event) => {
                    console.error('Database error:', event.target.error);
                    showToast('Database could not be opened.', 'error');
                    reject('DB Error');
                };

                request.onsuccess = (event) => {
                    state.db = event.target.result;
                    console.log('Database opened successfully.');
                    resolve();
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // Students Store
                    if (!db.objectStoreNames.contains('students')) {
                        const studentsStore = db.createObjectStore('students', { keyPath: 'id', autoIncrement: true });
                        studentsStore.createIndex('refNo', 'refNo', { unique: true });
                        studentsStore.createIndex('name', 'name', { unique: false });
                        studentsStore.createIndex('admNo', 'admNo', { unique: true });
                        studentsStore.createIndex('year', 'year', { unique: false });
                    }

                    // Departments Store
                    if (!db.objectStoreNames.contains('departments')) {
                        const deptStore = db.createObjectStore('departments', { keyPath: 'id', autoIncrement: true });
                        deptStore.createIndex('name', 'name', { unique: true });
                    }

                    // Courses Store
                    if (!db.objectStoreNames.contains('courses')) {
                        const courseStore = db.createObjectStore('courses', { keyPath: 'id', autoIncrement: true });
                        courseStore.createIndex('name', 'name', { unique: true });
                        courseStore.createIndex('deptId', 'deptId', { unique: false });
                    }

                    // Settings Store
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings', { keyPath: 'key' });
                    }

                    // Seed initial data
                    const transaction = event.target.transaction;
                    transaction.oncomplete = () => {
                        seedInitialData(db).then(resolve).catch(reject);
                    };
                };
            });
        }

        async function seedInitialData(db) {
            const deptTx = db.transaction('departments', 'readwrite');
            const deptStore = deptTx.objectStore('departments');
            const depts = [
                { name: 'Business', requirements: '2 passport photos\nKCSE cert\nID/Birth Cert' },
                { name: 'IT', requirements: '2 passport photos\nKCSE cert' },
                { name: 'Hospitality', requirements: '2 passport photos\nFood Handlers Certificate' }
            ];
            for (const dept of depts) {
                deptStore.add(dept);
            }
            await new Promise(resolve => deptTx.oncomplete = resolve);

            const courseTx = db.transaction(['departments', 'courses'], 'readwrite');
            const deptReadStore = courseTx.objectStore('departments');
            const businessDept = await getFromDB(deptReadStore, 'name', 'Business');
            const itDept = await getFromDB(deptReadStore, 'name', 'IT');

            const courseStore = courseTx.objectStore('courses');
            const courses = [
                { name: 'Diploma in Accounting', deptId: businessDept.id, deptName: businessDept.name },
                { name: 'Certificate in ICT', deptId: itDept.id, deptName: itDept.name }
            ];
            for (const course of courses) {
                courseStore.add(course);
            }
            await new Promise(resolve => courseTx.oncomplete = resolve);
            console.log('Initial data seeded.');
        }

        function getFromDB(store, indexName, value) {
            return new Promise((resolve, reject) => {
                const index = store.index(indexName);
                const request = index.get(value);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        function getByIdFromDB(storeName, id) {
            return new Promise((resolve, reject) => {
                const transaction = state.db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(id);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        function getFromDBByKey(storeName, key) {
            return new Promise((resolve, reject) => {
                const transaction = state.db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        function getAllFromDB(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = state.db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        function addToDB(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = state.db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        function updateInDB(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = state.db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        function deleteFromDB(storeName, id) {
            return new Promise((resolve, reject) => {
                const transaction = state.db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e.target.error);
            });
        }

        // --- NAVIGATION ---
        function setupEventListeners() {
            logoutBtn.addEventListener('click', handleLogout);

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const viewId = tab.dataset.view;
                    navigateToView(viewId);
                });
            });

            // Generate Form Listeners
            generateForm.headerImg.addEventListener('change', (e) => handleImageUpload(e, 'header'));
            generateForm.stampImg.addEventListener('change', (e) => handleImageUpload(e, 'stamp'));
            generateForm.course.addEventListener('change', handleCourseChange);
            generateForm.template.addEventListener('change', applyTemplateStyle);
            generateForm.btnGenerate.addEventListener('click', handleGenerate);
            generateForm.btnReset.addEventListener('click', resetGenerateForm);

            // Export/Share Listeners
            document.getElementById('btnPrintAdmission').addEventListener('click', () => printDocument('Admission'));
            document.getElementById('btnPdfAdmission').addEventListener('click', () => exportAsPDF('Admission'));
            document.getElementById('btnShareWhatsappAdmission').addEventListener('click', () => shareViaWhatsApp('Admission'));

            document.getElementById('btnPrintBursary').addEventListener('click', () => printDocument('Bursary'));
            document.getElementById('btnPdfBursary').addEventListener('click', () => exportAsPDF('Bursary'));
            document.getElementById('btnShareWhatsappBursary').addEventListener('click', () => shareViaWhatsApp('Bursary'));

            // Student List Listeners
            document.getElementById('studentSearch').addEventListener('input', loadStudentList);
            document.getElementById('studentYearFilter').addEventListener('change', loadStudentList);

            // Settings Listeners
            document.getElementById('deptForm').addEventListener('submit', handleAddDepartment);
            document.getElementById('courseForm').addEventListener('submit', handleAddCourse);
            document.getElementById('deptTable').addEventListener('click', handleDeptTableClick);
            document.getElementById('courseTable').addEventListener('click', handleCourseTableClick);
            document.getElementById('cancelDeptEditBtn').addEventListener('click', resetDeptForm);
            document.getElementById('cancelCourseEditBtn').addEventListener('click', resetCourseForm);

            // Backup/Restore Listeners
            document.getElementById('backupBtn').addEventListener('click', backupAllData);
            document.getElementById('restoreFile').addEventListener('change', (e) => {
                document.getElementById('restoreBtn').disabled = !e.target.files.length;
            });
            document.getElementById('restoreBtn').addEventListener('click', handleRestore);
            document.getElementById('clearDataBtn').addEventListener('click', handleClearAllData);
        }

        function navigateToView(viewId) {
            views.forEach(view => view.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');

            tabs.forEach(t => t.classList.remove('active'));
            document.querySelector(`.nav-tab[data-view="${viewId}"]`).classList.add('active');

            // Refresh data for specific views
            if (viewId === 'viewStudents') loadStudentList();
            if (viewId === 'viewAnalysis') updateAnalysisCharts();
            if (viewId === 'viewDashboard') updateDashboard();
        }

        // --- GENERATE & PREVIEW LOGIC ---
        async function handleGenerate() {
            if (!validateForm()) return;

            const refNo = await generateRefNo();
            const currentDate = formatDate(new Date());
            const selectedCourseOption = generateForm.course.options[generateForm.course.selectedIndex];

            const studentData = {
                id: generateForm.id.value ? parseInt(generateForm.id.value) : undefined,
                name: generateForm.name.value,
                admNo: generateForm.admNo.value,
                courseType: generateForm.courseType.value,
                courseId: parseInt(generateForm.course.value),
                courseName: selectedCourseOption.text,
                courseRequirements: generateForm.requirements.value,
                deptName: generateForm.dept.value,
                reportDate: generateForm.reportDate.value,
                feeBalance: parseFloat(generateForm.feeBalance.value),
                totalPerTerm: parseFloat(generateForm.totalPerTerm.value),
                refNo: refNo,
                createdAt: new Date().toISOString(),
                year: new Date(generateForm.reportDate.value).getFullYear(),
                template: generateForm.template.value,
                headerImg: state.headerImageDataUrl,
                stampImg: state.stampImageDataUrl,
                currentDate: currentDate
            };

            try {
                const savedId = await saveStudentRecord(studentData);
                studentData.id = savedId;
                state.currentStudentData = studentData;

                renderAdmissionPages(studentData);
                renderBursaryPage(studentData);
                applyTemplateStyle();

                admissionActions.classList.remove('hidden');
                bursaryActions.classList.remove('hidden');

                showToast(studentData.id ? 'Student record updated!' : 'Student record saved!', 'success');
                generateForm.btnGenerate.textContent = 'Generate & Save';
            } catch (error) {
                console.error('Error saving student:', error);
                showToast(`Error: ${error.message}. Admission No. may already exist.`, 'error');
            }
        }

        function validateForm() {
            let isValid = true;
            const requiredFields = [generateForm.name, generateForm.admNo, generateForm.course, generateForm.reportDate];
            requiredFields.forEach(field => {
                if (!field.value) {
                    field.style.borderColor = 'red';
                    isValid = false;
                } else {
                    field.style.borderColor = '';
                }
            });
            if (!isValid) showToast('Please fill all required fields.', 'error');
            return isValid;
        }

        function renderAdmissionPages(data) {
            const requirementsList = data.courseRequirements.split('\n').map(item => `<li>${item}</li>`).join('');

            previewAdmission.innerHTML = `
                <div class="page A4">
                    ${renderHeader(data)}
                    <div class="letter-body">
                        <p>Dear Sir/Madam,</p>
                        <p>&nbsp;</p>
                        <p>RE: Admission Letter</p>
                        <p>&nbsp;</p>
                        <p>Name: <strong>${data.name.toUpperCase()}</strong></p>
                        
                        <p>Congratulations! We are pleased to inform you that, with the approval of the Board of Directors, you have been admitted as a student of East Africa Vision Institute (EAVI).</p>
                        
                        <p>You have been admitted for the <strong>${data.courseType.toUpperCase()}</strong> in <strong>${data.courseName.toUpperCase()}</strong>, with Admission Number: <strong>${data.admNo.toUpperCase()}</strong>.</p>
                        
                        <p>You are required to report to the Institute on <strong>${formatDate(new Date(data.reportDate))}</strong>.</p>
                        <p>Note: Admission is valid for 7 days after the reporting date. You are required to report within this period.</p>
                        
                        <h4>Fee Payment Details</h4>
                        <p>
                            East Africa Vision Institute<br>
                            Equity Bank: Account No. 0470292838961<br>
                            KCB Bank: Account No. 1115207350<br>
                            M-PESA Paybill: 4129827 or 257557, Account Number: <strong>${data.name.toUpperCase()}</strong>
                        </p>
                        <p>Note: We do not accept cash payments. All fees must be deposited in the above accounts only.</p>
                        
                        <div class="letter-footer">
                            <p>Yours faithfully,</p>
                            ${renderStamp(data)}
                            <br><br><br>
                            <p>TRIZAH JUMA<br>
                            For Directors:<br>
                            Philemon Saina (B.Sc. Eng, MBA)<br>
                            Beth Mwangi (B.A, MBA, PhD Finance)<br>
                            R. B. Patel (B.Sc. Eng, M.Sc.)</p>
                        </div>
                    </div>
                </div>
                <div class="page A4">
                    <div class="letter-body">
                        <h2 style="text-align: center; text-decoration: underline; margin-bottom: 1.5cm;">REQUIREMENTS</h2>
                        <ul>${requirementsList}</ul>
                    </div>
                </div>
            `;
        }

        function renderBursaryPage(data) {
            previewBursary.innerHTML = `
                <div class="page A4">
                    ${renderHeader(data)}
                    <div class="letter-body">
                        <p>THE CHAIRPERSON<br>BURSARY COMMITTEE</p>
                        <p>&nbsp;</p>
                        <p>Dear Sir/Madam,</p>
                        <p>&nbsp;</p>
                        <p>RE: BURSARY SUPPORT</p>
                        <p>Name: <strong>${data.name.toUpperCase()}</strong><br>
                        The above named student, Adm. No: <strong>${data.admNo.toUpperCase()}</strong><br>                        
                        Enrolled for a <strong>${data.courseType.toUpperCase()}</strong> course in <strong>${data.courseName.toUpperCase()}</strong></p>
                        <p>Due to financial difficulty the student is not able to continue/start course immediately; therefore we request that you give this student school fee support. The student has a fee balance of <strong>KES ${data.feeBalance.toLocaleString()}</strong>. The total fees is <strong>KES ${data.totalPerTerm.toLocaleString()}</strong></p>
                        
                        <h4>Fee Payment Details</h4>
                        <p>
                            East Africa Vision Institute<br>
                            Equity Bank: Account No. 0470292838961<br>
                            KCB Bank: Account No. 1115207350
                        </p>
                        <p>I believe you will consider his/her request, thank you in advance,</p>

                        <div class="letter-footer">
                            <p>Yours faithfully,</p>
                            ${renderStamp(data)}
                            <br><br><br>
                            <p>For College Principal<br><strong>Trizah Juma</strong></p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderHeader(data) {
            return `
                ${data.headerImg ? `<img src="${data.headerImg}" class="page-header-img">` : '<div class="page-header-img" style="text-align:center; border:1px dashed #ccc; display:flex; align-items:center; justify-content:center; background-color:#f9f9f9;">Header Image Area (15cm x 4cm)</div>'}
                <div class="letter-header">
                    <span>OUR REF: ${data.refNo}</span>
                    <span>DATE: ${data.currentDate}</span>
                </div>
            `;
        }

        function renderStamp(data) {
            return `
                <div class="stamp-container">
                    ${data.stampImg ? `<img src="${data.stampImg}" class="stamp-img">` : '<div style="width:180px; height:180px; border:1px dashed #ccc; display:flex; align-items:center; justify-content:center;">Stamp Area</div>'}
                    <div class="stamp-date">${data.currentDate}</div>
                </div>
            `;
        }

        function applyTemplateStyle() {
            const templateKey = generateForm.template.value;
            const previews = [previewAdmission, previewBursary];
            previews.forEach(preview => {
                preview.classList.remove('template-classic', 'template-modern', 'template-minimal', 'template-bordered');
                if (templateKey) {
                    preview.classList.add(`template-${templateKey}`);
                }
            });
        }

        function handleImageUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                let key, previewElId;
                if (type === 'header') {
                    state.headerImageDataUrl = e.target.result;
                    key = 'headerImageDataUrl';
                    previewElId = 'headerPreview';
                } else if (type === 'stamp') {
                    state.stampImageDataUrl = e.target.result;
                    key = 'stampImageDataUrl';
                    previewElId = 'stampPreview';
                }

                if (key) {
                    await updateInDB('settings', { key: key, value: e.target.result });
                    const previewEl = document.getElementById(previewElId);
                    previewEl.src = e.target.result;
                    previewEl.classList.remove('hidden');
                }

                showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} image saved for future use.`, 'success');
                // Re-render if data exists
                if (state.currentStudentData) {
                    state.currentStudentData.headerImg = state.headerImageDataUrl;
                    state.currentStudentData.stampImg = state.stampImageDataUrl;
                    renderAdmissionPages(state.currentStudentData);
                    renderBursaryPage(state.currentStudentData);
                    applyTemplateStyle();
                }
            };
            reader.readAsDataURL(file);
        }

        async function handleCourseChange() {
            const courseId = parseInt(generateForm.course.value);
            generateForm.requirements.value = ''; // Clear previous
            generateForm.dept.value = ''; // Clear previous

            if (!courseId) {
                return;
            }

            try {
                const course = await getByIdFromDB('courses', courseId);
                if (course) {
                    const department = await getByIdFromDB('departments', course.deptId);
                    if (department) {
                        generateForm.dept.value = department.name;
                        generateForm.requirements.value = department.requirements || '';
                    }
                }
            } catch (error) {
                console.error("Error fetching department requirements:", error);
            }
        }

        function resetGenerateForm() {
            generateForm.id.value = '';
            generateForm.name.value = '';
            generateForm.admNo.value = '';
            generateForm.courseType.value = 'Diploma';
            generateForm.course.value = '';
            generateForm.requirements.value = '';
            generateForm.dept.value = '';
            generateForm.reportDate.value = '';
            generateForm.feeBalance.value = '0';
            generateForm.totalPerTerm.value = '0';
            generateForm.btnGenerate.textContent = 'Generate & Save';
            previewAdmission.innerHTML = '';
            previewBursary.innerHTML = '';
            admissionActions.classList.add('hidden');
            bursaryActions.classList.add('hidden');
            state.currentStudentData = null;
            showToast('Form cleared.', 'success');
        }

        // --- DATA HELPERS ---
        async function generateRefNo() {
            const transaction = state.db.transaction('students', 'readonly');
            const store = transaction.objectStore('students');
            const index = store.index('refNo');
            const request = index.openCursor(null, 'prev');
            
            return new Promise(resolve => {
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    let lastNum = 0;
                    if (cursor) {
                        const lastRef = cursor.value.refNo;
                        lastNum = parseInt(lastRef.split('/').pop());
                    }
                    const newNum = (lastNum + 1).toString().padStart(4, '0');
                    resolve(`EAVI/8833/${newNum}`);
                };
            });
        }

        function formatDate(date) {
            if (!date || isNaN(date)) return '';
            const d = new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${day}/${month}/${year}`;
        }

        async function saveStudentRecord(data) {
            if (data.id) {
                return updateInDB('students', data);
            } else {
                delete data.id; // ensure it's undefined for auto-increment
                return addToDB('students', data);
            }
        }

        // --- EXPORT & SHARE ---
        function getExportOptions(docType) {
            const element = docType === 'Admission' ? previewAdmission : previewBursary;
            const fileName = `${docType}-${state.currentStudentData.refNo.replace('/', '-')}.pdf`;
            return {
                margin: 0,
                filename: fileName,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'cm', format: 'a4', orientation: 'portrait' }
            };
        }

        function exportAsPDF(docType) {
            if (!state.currentStudentData) return;
            const options = getExportOptions(docType);
            const element = docType === 'Admission' ? previewAdmission : previewBursary;
            html2pdf().from(element).set(options).save();
        }

        async function printDocument(docType) {
            if (!state.currentStudentData) return;
            showToast('Generating PDF for printing...', 'info');
            let pdfUrl = null;

            try {
                const options = getExportOptions(docType);
                const element = docType === 'Admission' ? previewAdmission : previewBursary;

                // 1. Generate the PDF as a Blob
                const pdfBlob = await html2pdf().from(element).set(options).output('blob');
                
                // 2. Create an Object URL from the Blob, which is more reliable for iframes
                pdfUrl = URL.createObjectURL(pdfBlob);

                // 3. Create a hidden iframe to hold the PDF
                const iframe = document.createElement('iframe');
                iframe.style.position = 'fixed';
                iframe.style.left = '-9999px'; // Move it off-screen
                document.body.appendChild(iframe);

                // 4. Set its source to the PDF data and print when loaded
                iframe.src = pdfUrl;
                iframe.onload = function() {
                    try {
                        iframe.contentWindow.focus();

                        // The 'onafterprint' event fires after the user has finished with the print dialog.
                        // This is a more reliable way to clean up than a fixed timeout, preventing the dialog from closing prematurely.
                        iframe.contentWindow.onafterprint = () => {
                            document.body.removeChild(iframe);
                            URL.revokeObjectURL(pdfUrl); // Revoke the object URL to free up memory
                        };

                        iframe.contentWindow.print();
                        showToast('Print dialog opened.', 'success');
                    } catch (e) {
                        console.error('Print failed:', e);
                        showToast('Could not open print dialog. Please try downloading the PDF and printing it manually.', 'error');
                        // Clean up immediately if an error occurs
                        document.body.removeChild(iframe);
                        URL.revokeObjectURL(pdfUrl);
                    }
                };
            } catch (error) {
                console.error('Error generating PDF for printing:', error);
                showToast('Could not generate PDF for printing.', 'error');
                if (pdfUrl) {
                    URL.revokeObjectURL(pdfUrl);
                }
            }
        }

        async function shareViaWhatsApp(docType) {
            if (!state.currentStudentData) return;

            showToast('Generating PDF for sharing...', 'info');

            try {
                const options = getExportOptions(docType);
                const element = docType === 'Admission' ? previewAdmission : previewBursary;
                
                // 1. Generate the PDF as a blob object in memory
                const pdfBlob = await html2pdf().from(element).set(options).output('blob');
                const fileName = `${docType}-${state.currentStudentData.refNo.replace('/', '-')}.pdf`;
                const pdfFile = new File([pdfBlob], fileName, { type: 'application/pdf' });

                const shareData = {
                    files: [pdfFile],
                    title: `${docType} Letter for ${state.currentStudentData.name}`,
                    text: `Hello, here is the ${docType.toLowerCase()} letter for ${state.currentStudentData.name} (Ref: ${state.currentStudentData.refNo}).`,
                };

                // 2. Check if the browser supports the Web Share API for files
                if (navigator.canShare && navigator.canShare(shareData)) {
                    // 3. Use the native mobile share functionality
                    await navigator.share(shareData);
                    showToast('Share dialog opened.', 'success');
                } else {
                    // 4. Fallback for desktop browsers: download the file and open WhatsApp
                    showToast('Web Share not supported. Downloading PDF instead.', 'info');
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(pdfBlob);
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);

                    const message = `Hello, please find the attached ${docType} letter for ${state.currentStudentData.name} (Ref: ${state.currentStudentData.refNo}).`;
                    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
                    window.open(whatsappUrl, '_blank');
                    showToast('PDF downloaded. Please attach it in the new WhatsApp tab.', 'success');
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Share was cancelled by the user.');
                } else {
                    console.error('Error sharing PDF:', error);
                    showToast('Could not share or generate PDF.', 'error');
                }
            }
        }

        // --- STUDENT LIST ---
        async function loadStudentList() {
            const students = await getAllFromDB('students');
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
            const yearFilter = document.getElementById('studentYearFilter').value;

            const filteredStudents = students.filter(s => {
                const matchesSearch = s.name.toLowerCase().includes(searchTerm) || s.admNo.toLowerCase().includes(searchTerm);
                const matchesYear = !yearFilter || s.year == yearFilter;
                return matchesSearch && matchesYear;
            }).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            populateStudentTable(filteredStudents);
            populateYearFilter(students);
        }

        function populateStudentTable(students) {
            const tbody = document.getElementById('studentsTable').querySelector('tbody');
            tbody.innerHTML = '';
            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No students found.</td></tr>';
                return;
            }
            students.forEach(s => {
                const row = `
                    <tr>
                        <td>${s.refNo}</td>
                        <td>${s.name}</td>
                        <td>${s.admNo}</td>
                        <td>${s.courseName}</td>
                        <td>${formatDate(new Date(s.reportDate))}</td>
                        <td>${s.year}</td>
                        <td class="btn-group">
                            <button class="btn btn-sm btn-primary" onclick="app.viewStudent(${s.id})">View</button>
                            <button class="btn btn-sm btn-secondary" onclick="app.regenerateStudent(${s.id})">Regenerate / Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="app.deleteStudent(${s.id})">Delete</button>
                        </td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        function populateYearFilter(students) {
            const yearFilterEl = document.getElementById('studentYearFilter');
            const currentVal = yearFilterEl.value;
            const years = [...new Set(students.map(s => s.year))].sort((a, b) => b - a);
            yearFilterEl.innerHTML = '<option value="">All Years</option>';
            years.forEach(year => {
                yearFilterEl.innerHTML += `<option value="${year}">${year}</option>`;
            });
            yearFilterEl.value = currentVal;
        }

        async function viewStudent(id) {
            const student = await getByIdFromDB('students', id);
            if (student) {
                state.currentStudentData = student;
                renderAdmissionPages(student);
                renderBursaryPage(student);
                applyTemplateStyle();
                admissionActions.classList.remove('hidden');
                bursaryActions.classList.remove('hidden');
                navigateToView('viewGenerate');
                showToast(`Viewing record for ${student.name}`, 'success');
            }
        }

        async function regenerateStudent(id) {
            const student = await getByIdFromDB('students', id);
            if (student) {
                // 1. Reset and populate the form with the student's text data
                resetGenerateForm();
                generateForm.id.value = student.id;
                generateForm.name.value = student.name;
                generateForm.admNo.value = student.admNo;
                generateForm.courseType.value = student.courseType || 'Diploma';
                generateForm.course.value = student.courseId;
                await handleCourseChange(); // To update the department field
                generateForm.reportDate.value = student.reportDate.split('T')[0];
                generateForm.feeBalance.value = student.feeBalance;
                generateForm.totalPerTerm.value = student.totalPerTerm;
                generateForm.template.value = student.template;
                generateForm.btnGenerate.textContent = 'Update Record';

                // 2. Create a temporary data object for the preview.
                //    Use the loaded student data, but overwrite images with the current app state.
                const previewData = {
                    ...student,
                    headerImg: state.headerImageDataUrl,
                    stampImg: state.stampImageDataUrl,
                    currentDate: formatDate(new Date()) // Use today's date for the preview
                };
                
                // 3. Set this as the current student data and render the previews
                state.currentStudentData = previewData;
                renderAdmissionPages(previewData);
                renderBursaryPage(previewData);
                applyTemplateStyle();
                
                // 4. Show action buttons and navigate
                admissionActions.classList.remove('hidden');
                bursaryActions.classList.remove('hidden');
                navigateToView('viewGenerate');
                showToast(`Editing record for ${student.name}. Previews updated with current images.`, 'success');
            }
        }

        async function deleteStudent(id) {
            if (confirm('Are you sure you want to delete this student record? This cannot be undone.')) {
                await deleteFromDB('students', id);
                showToast('Student record deleted.', 'success');
                loadStudentList();
            }
        }

        // --- ANALYSIS ---
        async function updateAnalysisCharts() {
            const students = await getAllFromDB('students');

            // Admissions per Year
            const admissionsByYear = students.reduce((acc, s) => {
                acc[s.year] = (acc[s.year] || 0) + 1;
                return acc;
            }, {});
            renderChart('admissionsPerYearChart', 'bar', 'Admissions per Year', Object.keys(admissionsByYear), Object.values(admissionsByYear));

            // Admissions by Department
            const admissionsByDept = students.reduce((acc, s) => {
                acc[s.deptName] = (acc[s.deptName] || 0) + 1;
                return acc;
            }, {});
            renderChart('admissionsByDeptChart', 'pie', 'Admissions by Department', Object.keys(admissionsByDept), Object.values(admissionsByDept));
        }

        function renderChart(canvasId, type, label, labels, data) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (state.charts[canvasId]) {
                state.charts[canvasId].destroy();
            }
            state.charts[canvasId] = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: type === 'pie' ? ['#005a9e', '#fdb813', '#003d6b', '#5a6772', '#e1e5e8'] : '#005a9e',
                    }]
                },
                options: { responsive: true, maintainAspectRatio: true }
            });
        }

        // --- DASHBOARD ---
        async function updateDashboard() {
            const students = await getAllFromDB('students');
            const courses = await getAllFromDB('courses');
            const depts = await getAllFromDB('departments');

            const dashboardContent = `
                <div class="card">
                    <h2 class="card-header">System Overview</h2>
                    <div class="grid-3">
                        <div class="card"><h3>${students.length}</h3><p>Total Students</p></div>
                        <div class="card"><h3>${courses.length}</h3><p>Total Courses</p></div>
                        <div class="card"><h3>${depts.length}</h3><p>Total Departments</p></div>
                    </div>
                </div>
            `;
            document.getElementById('viewDashboard').innerHTML = dashboardContent;
        }

        // --- PERSISTED SETTINGS (Images) ---
        async function loadPersistedSettings() {
            try {
                const headerImgSetting = await getFromDBByKey('settings', 'headerImageDataUrl');
                if (headerImgSetting && headerImgSetting.value) {
                    state.headerImageDataUrl = headerImgSetting.value;
                    const headerPreview = document.getElementById('headerPreview');
                    headerPreview.src = state.headerImageDataUrl;
                    headerPreview.classList.remove('hidden');
                }
                const stampImgSetting = await getFromDBByKey('settings', 'stampImageDataUrl');
                if (stampImgSetting && stampImgSetting.value) {
                    state.stampImageDataUrl = stampImgSetting.value;
                    const stampPreview = document.getElementById('stampPreview');
                    stampPreview.src = state.stampImageDataUrl;
                    stampPreview.classList.remove('hidden');
                }
                if (headerImgSetting || stampImgSetting) {
                    showToast('Loaded saved images.', 'success');
                }
            } catch (e) {
                console.warn("Could not load persisted settings.", e);
            }
        }

        // --- SETTINGS ---
        async function loadCoursesAndDepartments() {
            const depts = await getAllFromDB('departments');
            const courses = await getAllFromDB('courses');

            // Populate department dropdowns
            const deptSelects = [document.getElementById('courseDept')];
            deptSelects.forEach(select => {
                select.innerHTML = '<option value="">Select Department</option>';
                depts.forEach(d => select.innerHTML += `<option value="${d.id}">${d.name}</option>`);
            });

            // Populate course dropdown
            const courseSelect = generateForm.course;
            courseSelect.innerHTML = '<option value="">Select Course</option>';
            courses.forEach(c => courseSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`);

            // Populate tables
            populateDeptTable(depts);
            populateCourseTable(courses);
        }

        function populateDeptTable(depts) {
            const tbody = document.getElementById('deptTable').querySelector('tbody');
            tbody.innerHTML = '';
            depts.forEach(d => tbody.innerHTML += `
                <tr>
                    <td>${d.name}</td>
                    <td class="btn-group">
                        <button class="btn btn-sm btn-secondary" data-id="${d.id}" data-action="edit">Edit</button>
                        <button class="btn btn-sm btn-danger" data-id="${d.id}" data-action="delete">Delete</button>
                    </td>
                </tr>`);
        }

        function populateCourseTable(courses) {
            const tbody = document.getElementById('courseTable').querySelector('tbody');
            tbody.innerHTML = '';
            courses.forEach(c => tbody.innerHTML += `
                <tr>
                    <td>${c.name}</td>
                    <td>${c.deptName}</td>
                    <td class="btn-group">
                        <button class="btn btn-sm btn-secondary" data-id="${c.id}" data-action="edit">Edit</button>
                        <button class="btn btn-sm btn-danger" data-id="${c.id}" data-action="delete">Delete</button>
                    </td>
                </tr>`);
        }

        async function handleAddDepartment(e) {
            e.preventDefault();
            const name = document.getElementById('deptName').value.trim();
            const requirements = document.getElementById('deptRequirements').value.trim();
            if (!name) return;
            const editingId = document.getElementById('editingDeptId').value;

            const deptData = { name, requirements };

            try {
                if (editingId) {
                    deptData.id = parseInt(editingId);
                    await updateInDB('departments', deptData);
                    showToast('Department updated.', 'success');
                } else {
                    await addToDB('departments', deptData);
                    showToast('Department added.', 'success');
                }
                resetDeptForm();
                loadCoursesAndDepartments();
            } catch (error) {
                showToast('Department name must be unique.', 'error');
            }
        }

        async function handleAddCourse(e) {
            e.preventDefault();
            const name = document.getElementById('courseName').value.trim();
            const deptId = parseInt(document.getElementById('courseDept').value);
            if (!name || !deptId) return;
            const editingId = document.getElementById('editingCourseId').value;

            const deptSelect = document.getElementById('courseDept');
            const deptName = deptSelect.options[deptSelect.selectedIndex].text;
            const courseData = { name, deptId, deptName };

            try {
                if (editingId) {
                    courseData.id = parseInt(editingId);
                    await updateInDB('courses', courseData);
                    showToast('Course updated.', 'success');
                } else {
                    await addToDB('courses', courseData);
                    showToast('Course added.', 'success');
                }
                resetCourseForm();
                loadCoursesAndDepartments();
            } catch (error) {
                showToast('Course name must be unique.', 'error');
            }
        }

        function resetDeptForm() {
            document.getElementById('deptForm').reset();
            document.getElementById('editingDeptId').value = '';
            const submitBtn = document.querySelector('#deptForm button[type="submit"]');
            submitBtn.textContent = 'Add Department';
            submitBtn.classList.remove('btn-success');
            submitBtn.classList.add('btn-primary');
            document.getElementById('cancelDeptEditBtn').classList.add('hidden');
        }

        function resetCourseForm() {
            document.getElementById('courseForm').reset();
            document.getElementById('editingCourseId').value = '';
            const submitBtn = document.querySelector('#courseForm button[type="submit"]');
            submitBtn.textContent = 'Add Course';
            submitBtn.classList.remove('btn-success');
            submitBtn.classList.add('btn-primary');
            document.getElementById('cancelCourseEditBtn').classList.add('hidden');
        }

        async function handleEditDepartment(id) {
            const dept = await getByIdFromDB('departments', id);
            if (dept) {
                document.getElementById('editingDeptId').value = dept.id;
                document.getElementById('deptName').value = dept.name;
                document.getElementById('deptRequirements').value = dept.requirements || '';
                const submitBtn = document.querySelector('#deptForm button[type="submit"]');
                submitBtn.textContent = 'Update Department';
                submitBtn.classList.remove('btn-primary');
                submitBtn.classList.add('btn-success');
                document.getElementById('cancelDeptEditBtn').classList.remove('hidden');
            }
        }

        async function handleEditCourse(id) {
            const course = await getByIdFromDB('courses', id);
            if (course) {
                document.getElementById('editingCourseId').value = course.id;
                document.getElementById('courseName').value = course.name;
                document.getElementById('courseDept').value = course.deptId;
                const submitBtn = document.querySelector('#courseForm button[type="submit"]');
                submitBtn.textContent = 'Update Course';
                submitBtn.classList.remove('btn-primary');
                submitBtn.classList.add('btn-success');
                document.getElementById('cancelCourseEditBtn').classList.remove('hidden');
            }
        }

        async function handleDeptTableClick(e) {
            if (e.target.tagName === 'BUTTON' && e.target.dataset.id) {
                const id = parseInt(e.target.dataset.id);
                const action = e.target.dataset.action;

                if (action === 'edit') {
                    handleEditDepartment(id);
                } else if (action === 'delete' && confirm('Are you sure you want to delete this department? This might affect existing student records.')) {
                    await deleteFromDB('departments', id);
                    showToast('Department deleted.', 'success');
                    loadCoursesAndDepartments();
                }
            }
        }

        async function handleCourseTableClick(e) {
            if (e.target.tagName === 'BUTTON' && e.target.dataset.id) {
                const id = parseInt(e.target.dataset.id);
                const action = e.target.dataset.action;

                if (action === 'edit') {
                    handleEditCourse(id);
                } else if (action === 'delete' && confirm('Are you sure you want to delete this course? This might affect existing student records.')) {
                    await deleteFromDB('courses', id);
                    showToast('Course deleted.', 'success');
                    loadCoursesAndDepartments();
                }
            }
        }

        // --- BACKUP & RESTORE ---
        async function backupAllData() {
            const data = {
                students: await getAllFromDB('students'),
                departments: await getAllFromDB('departments'),
                courses: await getAllFromDB('courses'),
                settings: await getAllFromDB('settings'),
            };
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `eavi-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Backup created successfully.', 'success');
        }

        function handleRestore() {
            const file = document.getElementById('restoreFile').files[0];
            if (!file) return;
            if (!confirm('WARNING: This will overwrite all existing data. Are you sure you want to proceed?')) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.students || !data.departments || !data.courses ) {
                        throw new Error('Invalid backup file format.');
                    }

                    const allStores = ['students', 'departments', 'courses', 'settings'];
                    const tx = state.db.transaction(allStores, 'readwrite');

                    // Clear existing data
                    for (const storeName of allStores) {
                        const store = tx.objectStore(storeName);
                        await new Promise(resolve => store.clear().onsuccess = resolve);
                    }

                    // Add new data
                    for (const storeName of allStores) {
                        if (data[storeName]) {
                            const store = tx.objectStore(storeName);
                            for (const item of data[storeName]) {
                                if (item.id && ['students', 'departments', 'courses'].includes(storeName)) {
                                    delete item.id;
                                }
                                await new Promise(resolve => store.add(item).onsuccess = resolve);
                            }
                        }
                    }

                    await new Promise(resolve => tx.oncomplete = resolve);

                    showToast('Data restored successfully. Reloading application...', 'success');
                    setTimeout(() => window.location.reload(), 2000);

                } catch (error) {
                    console.error('Restore error:', error);
                    showToast(`Restore failed: ${error.message}`, 'error');
                }
            };
            reader.readAsText(file);
        }

        async function handleClearAllData() {
            const confirmation = prompt("This will permanently delete ALL data, including students, courses, and saved images. This action cannot be undone.\n\nTo confirm, please type 'DELETE' in the box below.");
            if (confirmation === 'DELETE') {
                try {
                    showToast('Clearing all data...', 'info');
                    const allStores = ['students', 'departments', 'courses', 'settings'];
                    const tx = state.db.transaction(allStores, 'readwrite');

                    for (const storeName of allStores) {
                        const store = tx.objectStore(storeName);
                        await new Promise((resolve, reject) => {
                            const request = store.clear();
                            request.onsuccess = resolve;
                            request.onerror = reject;
                        });
                    }

                    await new Promise(resolve => tx.oncomplete = resolve);

                    showToast('All application data has been cleared. Reloading...', 'success');
                    setTimeout(() => {
                        sessionStorage.clear();
                        window.location.reload();
                    }, 2000);
                } catch (error) {
                    console.error('Error clearing data:', error);
                    showToast('Failed to clear data.', 'error');
                }
            } else {
                showToast('Clear data operation cancelled.', 'info');
            }
        }

        // --- UTILITIES ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 4000);
        }

        function showUpdateBar(registration) {
            const updateBar = document.getElementById('update-bar');
            const updateBtn = document.getElementById('update-btn');

            updateBtn.addEventListener('click', () => {
                if (registration.waiting) {
                    // Send a message to the waiting service worker to skip waiting.
                    registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                }
            });
            updateBar.classList.add('show');
        }

        // --- GLOBAL ACCESS ---
        // Expose functions needed by inline onclick handlers
        window.app = {
            viewStudent,
            regenerateStudent,
            deleteStudent
        };

        // --- START THE APP ---
        init();

        // --- PWA Service Worker Registration ---
        let refreshing;
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);

                        // --- PWA Update Logic ---
                        registration.onupdatefound = () => {
                            const installingWorker = registration.installing;
                            if (installingWorker == null) {
                                return;
                            }
                            installingWorker.onstatechange = () => {
                                if (installingWorker.state === 'installed') {
                                    if (navigator.serviceWorker.controller) {
                                        // New update available.
                                        console.log('New content is available, prompting user to update.');
                                        showUpdateBar(registration);
                                    }
                                }
                            };
                        };
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });

            // This event fires when the service worker controlling this page changes.
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (!refreshing) {
                    window.location.reload();
                    refreshing = true;
                }
            });
        }
    });
    </script>
</body>
</html>