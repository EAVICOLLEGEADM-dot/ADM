<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EAVI Admission & Bursary System</title>

    <!-- CDN Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVXM5BCClRCagvRMDCGkuVTzpbclw==" crossorigin="anonymous" referrerpolicy="no-referrer" onerror="loadHtml2CanvasBackup()"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNhlrdUHdmcr0DJce4w2xUyBIgCE8c1I9uM0VYqNg0z6CNIlMQSQPL7M8=" crossorigin="anonymous" referrerpolicy="no-referrer" onerror="loadJsPDFBackup()"></script>
    <script>
        // Backup CDN loader for html2canvas
        function loadHtml2CanvasBackup() {
            console.log('Loading html2canvas backup CDN...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js';
            script.onerror = function() {
                console.error('Both html2canvas CDN sources failed to load');
                alert('HTML2Canvas library failed to load. Please check your internet connection and refresh the page.');
            };
            document.head.appendChild(script);
        }
        
        // Backup CDN loader for jsPDF
        function loadJsPDFBackup() {
            console.log('Loading jsPDF backup CDN...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js';
            script.onerror = function() {
                console.error('Both jsPDF CDN sources failed to load');
                alert('PDF library failed to load. Please check your internet connection and refresh the page.');
            };
            document.head.appendChild(script);
        }
        
        // Test library availability after page load
        window.addEventListener('load', function() {
            setTimeout(function() {
                // Check html2canvas
                if (!window.html2canvas) {
                    console.warn('html2canvas not detected, attempting to load backup...');
                    loadHtml2CanvasBackup();
                }
                
                // Check jsPDF
                if (!window.jspdf && !window.jsPDF) {
                    console.warn('jsPDF not detected, attempting to load backup...');
                    loadJsPDFBackup();
                }
            }, 1000);
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        /* --- GLOBAL STYLES & RESET --- */
        :root {
            --primary-color: #667eea;
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-color: #4c63d2;
            --accent-color: #f093fb;
            --accent-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-color: #4ecdc4;
            --warning-color: #fce38a;
            --danger-color: #ff6b6b;
            --light-gray: #f8fafc;
            --medium-gray: #e2e8f0;
            --dark-gray: #64748b;
            --text-color: #334155;
            --text-light: #64748b;
            --white: #ffffff;
            --shadow-light: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-medium: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-heavy: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --border-radius: 12px;
            --border-radius-lg: 16px;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            font-family: var(--font-family);
            background: var(--light-gray);
            color: var(--text-color);
            font-size: 16px;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            /* Enable smooth scrolling and touch behaviors */
            scroll-behavior: smooth;
            -webkit-text-size-adjust: 100%;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        }

        /* Improve touch targets for mobile */
        button, 
        input[type="button"], 
        input[type="submit"], 
        input[type="reset"], 
        [role="button"], 
        .btn {
            min-height: 44px;
            min-width: 44px;
            cursor: pointer;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        /* Focus states for accessibility */
        *:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .hidden { 
            display: none !important; 
        }

        /* --- LOGIN VIEW --- */
        #loginView {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: var(--primary-gradient);
            padding: 1rem;
        }

        .login-card {
            background: var(--white);
            padding: 2.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-heavy);
            width: 100%;
            max-width: 420px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .login-card h1 {
            margin-bottom: 0.5rem;
            color: var(--text-color);
            font-weight: 700;
            font-size: 2rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .login-card p {
            margin-bottom: 2rem;
            color: var(--text-light);
            font-weight: 400;
        }

        .login-card .input-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .login-card label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color);
            font-size: 0.875rem;
        }

        .login-card input,
        .login-card select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--medium-gray);
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-family: inherit;
            transition: var(--transition);
            background: var(--white);
        }

        .login-card input:focus,
        .login-card select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        #loginBtn {
            width: 100%;
            padding: 0.875rem;
            background: var(--primary-gradient);
            color: var(--white);
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #loginBtn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        #loginBtn:active {
            transform: translateY(0);
        }

        #loginError {
            color: var(--danger-color);
            margin-top: 1rem;
            min-height: 1.2em;
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* Mobile responsiveness for login */
        @media (max-width: 480px) {
            .login-card {
                padding: 2rem 1.5rem;
                margin: 1rem;
            }
            
            .login-card h1 {
                font-size: 1.75rem;
            }
        }
        
        @media (max-width: 320px) {
            .login-card {
                padding: 1.5rem 1rem;
            }
            
            .login-card h1 {
                font-size: 1.5rem;
            }
        }

        /* --- MAIN APP VIEW --- */
        #appView {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .navbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--white);
            padding: 1rem 2rem;
            box-shadow: var(--shadow-light);
            border-bottom: 1px solid var(--medium-gray);
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .navbar-brand {
            font-size: 1.75rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-right: 2rem;
        }

        .nav-tabs {
            display: flex;
            flex-grow: 1;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }

        .nav-tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-radius: var(--border-radius);
            color: var(--text-light);
            font-weight: 500;
            transition: var(--transition);
            white-space: nowrap;
            margin-right: 0.5rem;
            font-size: 0.875rem;
        }

        .nav-tab:hover {
            background: var(--light-gray);
            color: var(--primary-color);
        }

        .nav-tab.active {
            background: var(--primary-gradient);
            color: var(--white);
            box-shadow: var(--shadow-light);
        }

        .navbar-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        #adminInfo {
            color: var(--text-light);
            font-size: 0.875rem;
            font-weight: 500;
        }

        #logoutBtn {
            background: transparent;
            border: 2px solid var(--medium-gray);
            color: var(--text-color);
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            font-size: 0.875rem;
        }

        #logoutBtn:hover {
            background: var(--danger-color);
            color: var(--white);
            border-color: var(--danger-color);
            transform: translateY(-1px);
        }

        .main-content {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .view-content {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Mobile navbar */
        @media (max-width: 768px) {
            .navbar {
                padding: 1rem;
                flex-wrap: wrap;
            }
            
            .navbar-brand {
                font-size: 1.5rem;
                margin-right: 1rem;
            }
            
            .nav-tabs {
                width: 100%;
                order: 3;
                margin-top: 1rem;
                padding-top: 1rem;
                border-top: 1px solid var(--medium-gray);
            }
            
            .nav-tab {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
                margin-right: 0.25rem;
            }
            
            #adminInfo {
                display: none;
            }
            
            .main-content {
                padding: 1rem;
            }
        }
        
        @media (max-width: 480px) {
            .navbar {
                padding: 0.75rem;
            }
            
            .navbar-brand {
                font-size: 1.25rem;
                margin-right: 0.5rem;
            }
            
            .nav-tabs {
                margin-top: 0.75rem;
                padding-top: 0.75rem;
            }
            
            .nav-tab {
                padding: 0.375rem 0.75rem;
                font-size: 0.75rem;
                margin-right: 0.125rem;
            }
            
            .main-content {
                padding: 0.75rem;
            }
        }

        /* --- UI COMPONENTS --- */
        .card {
            background: var(--white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-light);
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.8);
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }

        .card-header {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--light-gray);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-color);
            font-size: 0.875rem;
        }

        .form-group input, 
        .form-group select, 
        .form-group textarea {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--medium-gray);
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-family: inherit;
            transition: var(--transition);
            background: var(--white);
        }

        .form-group input:focus, 
        .form-group select:focus, 
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input[type="file"] {
            padding: 0.75rem;
            border-style: dashed;
        }

        .form-group input:read-only {
            background-color: var(--light-gray);
            cursor: not-allowed;
        }

        .form-group small {
            color: var(--text-light);
            font-size: 0.8rem;
            margin-top: 0.25rem;
            display: block;
        }

        /* Mobile form adjustments */
        @media (max-width: 768px) {
            .card {
                padding: 1.5rem;
                margin-bottom: 1rem;
            }
            
            .grid-2,
            .grid-3 {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .card-header {
                font-size: 1.25rem;
            }
        }

        .btn {
            padding: 0.875rem 1.5rem;
            border-radius: var(--border-radius);
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: var(--shadow-light);
            font-family: inherit;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled,
        .btn[disabled] {
            background-color: var(--medium-gray) !important;
            color: var(--text-light) !important;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-primary { 
            background: var(--primary-gradient); 
            color: var(--white); 
        }

        .btn-secondary { 
            background: var(--dark-gray); 
            color: var(--white); 
        }
        .btn-secondary:hover { 
            background: #475569; 
        }

        .btn-danger { 
            background: var(--danger-color); 
            color: var(--white); 
        }
        .btn-danger:hover { 
            background: #e53e3e; 
        }

        .btn-success { 
            background: var(--success-color); 
            color: var(--white); 
        }
        .btn-success:hover { 
            background: #38b2ac; 
        }

        .btn-group {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            text-transform: none;
        }

        /* Mobile button adjustments */
        @media (max-width: 768px) {
            .btn {
                padding: 0.75rem 1.25rem;
                font-size: 0.8rem;
            }
            
            .btn-group {
                gap: 0.5rem;
                flex-wrap: wrap;
            }
            
            .btn-sm {
                padding: 0.5rem 0.875rem;
                font-size: 0.7rem;
            }
        }
        
        @media (max-width: 480px) {
            .btn {
                padding: 0.625rem 1rem;
                font-size: 0.75rem;
                min-width: auto;
            }
            
            .btn-group {
                gap: 0.375rem;
            }
            
            .btn-group .btn {
                flex: 1;
                min-width: 0;
            }
            
            .btn-sm {
                padding: 0.375rem 0.75rem;
                font-size: 0.65rem;
            }
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
            background: var(--white);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-light);
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--medium-gray);
        }

        th {
            background: var(--light-gray);
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tbody tr {
            transition: var(--transition);
        }

        tbody tr:hover {
            background-color: rgba(102, 126, 234, 0.05);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        /* Responsive table */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
        }
        
        @media (max-width: 768px) {
            .table-container {
                margin: 0 -1rem;
                border-radius: 0;
            }
            
            table {
                min-width: 700px;
                font-size: 0.8rem;
            }
            
            th, td {
                padding: 0.75rem 0.5rem;
                white-space: nowrap;
            }
            
            th {
                font-size: 0.75rem;
            }
        }
        
        @media (max-width: 480px) {
            .table-container {
                margin: 0 -0.75rem;
            }
            
            table {
                min-width: 650px;
                font-size: 0.75rem;
            }
            
            th, td {
                padding: 0.5rem 0.375rem;
            }
            
            th {
                font-size: 0.7rem;
            }
        }

        /* --- SPECIAL COMPONENTS --- */
        .indicator {
            background: linear-gradient(135deg, var(--light-gray) 0%, #f1f5f9 100%);
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--primary-color);
            box-shadow: var(--shadow-light);
        }

        .indicator strong {
            color: var(--text-color);
            font-weight: 600;
        }

        .status-success {
            color: var(--success-color);
            font-weight: 600;
        }

        .status-error {
            color: var(--danger-color);
            font-weight: 600;
        }

        /* --- CHART CONTAINER STYLES --- */
        .chart-container {
            background: var(--white);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-light);
            margin-bottom: 1rem;
        }

        .chart-container h3 {
            color: var(--text-color);
            font-weight: 600;
            margin-bottom: 1rem;
            font-size: 1.125rem;
        }

        .chart-container canvas {
            max-height: 300px;
        }

        /* Mobile chart adjustments */
        @media (max-width: 768px) {
            .chart-container {
                padding: 1rem;
            }
            
            .chart-container canvas {
                max-height: 250px;
            }
        }

        /* --- PREVIEW CONTAINER --- */
        .preview-container {
            background: linear-gradient(135deg, var(--dark-gray) 0%, #475569 100%);
            padding: 2rem;
            border-radius: var(--border-radius-lg);
            min-height: calc(100vh - 200px);
            overflow: auto;
        }

        .preview-area {
            margin-bottom: 2rem;
        }

        .preview-area h3 {
            color: var(--white);
            margin-bottom: 1rem;
            font-weight: 600;
        }

        /* Mobile preview adjustments */
        @media (max-width: 768px) {
            .preview-container {
                padding: 1rem;
                min-height: 50vh;
            }
            
            #viewGenerate .grid-2 {
                grid-template-columns: 1fr;
            }

            /* Mobile A4 page adjustments */
            .page {
                padding: 10mm;
                font-size: 14px;
                margin-bottom: 0.25cm;
                box-shadow: 0 0 0.25cm rgba(0,0,0,0.3);
                width: 210mm;
                height: 297mm;
            }
            
            .page.A4 {
                width: calc(100vw - 2rem);
                max-width: 210mm;
                min-height: 297mm;
            }
        }

        /* --- CLEAN PDF LAYOUT --- */
        .page {
            background: white;
            display: block;
            margin: 0 auto;
            margin-bottom: 1rem;
            padding: 10mm;
            color: #000;
            font-size: 16px;
            font-family: Arial, sans-serif;
            line-height: 1.6;
            width: 210mm;
            height: 297mm;
            box-sizing: border-box;
        }

        .page.A4 {
            min-height: 297mm;
        }

        .page-header-img {
            display: block;
            max-width: 100%;
            height: auto;
            margin: 0 auto 1.5rem;
        }

        .letter-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            font-weight: bold;
            color: #000;
            font-size: 1rem;
            flex-wrap: wrap;
        }

        .letter-body {
            color: #000;
            font-size: 1rem;
            line-height: 1.6;
        }

        .letter-body h3 {
            color: #000;
            text-decoration: underline;
            margin: 1.5rem 0 1rem 0;
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
        }

        .letter-body h4 {
            color: #000;
            margin: 1.5rem 0 1rem 0;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .letter-body p {
            margin-bottom: 1rem;
            text-align: left;
        }

        .letter-body ul {
            margin: 1rem 0;
            padding-left: 2rem;
        }

        .letter-body li {
            margin-bottom: 0.5rem;
        }

        .student-name,
        .course-name,
        .admission-number,
        .reporting-date,
        .fee-amount {
            font-weight: bold;
        }

        .payment-details {
            background: #f8f9fa;
            padding: 1rem;
            margin: 1rem 0;
            border: 1px solid #ddd;
        }

        .important-note {
            background: #fff3cd;
            padding: 1rem;
            margin: 1rem 0;
            border: 1px solid #ffeaa7;
        }

        .congratulations {
            background: #d4edda;
            padding: 1rem;
            margin: 1rem 0;
            border: 1px solid #c3e6cb;
        }

        .details-block {
            margin: 1.5rem 0;
        }

        .letter-footer {
            margin-top: 2rem;
        }

        .signature-section {
            margin: 1rem 0;
        }

        .signature-spacing {
            margin-top: 2rem;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .page {
                padding: 1rem;
                margin-bottom: 0.5rem;
                font-size: 14px;
            }
            
            .letter-header {
                flex-direction: column;
                text-align: center;
                gap: 0.5rem;
            }
            
            .letter-body h3 {
                font-size: 1.1rem;
            }
            
            .letter-body h4 {
                font-size: 1rem;
            }
            
            .payment-details,
            .important-note,
            .congratulations {
                padding: 0.75rem;
            }
        }

        @media (max-width: 480px) {
            .page {
                padding: 0.75rem;
                font-size: 13px;
            }
            
            .letter-body h3 {
                font-size: 1rem;
            }
            
            .letter-body h4 {
                font-size: 0.95rem;
            }
            
            .payment-details,
            .important-note,
            .congratulations {
                padding: 0.5rem;
            }
        }

        .single-page .letter-body .details-block {
            margin: 0.4cm 0;
        }

        .letter-body .details-block span {
            font-weight: bold;
        }

        .letter-footer {
            margin-top: 2cm;
            position: relative;
        }

        .single-page .letter-footer {
            margin-top: 0.4cm;
        }

        .letter-footer .signature-section {
            color: #2c3e50;
            font-weight: 500;
        }

        .signature-spacing {
            margin-top: 0.8cm;
        }

        .single-page .signature-spacing {
            margin-top: 0.4cm;
        }

        .stamp-container {
            position: absolute;
            top: -0.5cm;
            right: 2cm;
            width: 220px;
            height: 180px;
        }

        .single-page .stamp-container {
            width: 150px;
            height: 120px;
            right: 0.8cm;
            top: -0.3cm;
        }

        .stamp-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* Requirements page - hide when printing */
        .requirements-page {
            /* This will be hidden in print styles */
        }

        /* Mobile A4 page adjustments */
        @media (max-width: 768px) {
            .page {
                padding: 1cm;
                font-size: 14px;
                margin-bottom: 0.25cm;
                box-shadow: 0 0 0.25cm rgba(0,0,0,0.3);
            }
            
            .page.A4 {
                width: calc(100vw - 2rem);
                max-width: 21cm;
            }
            
            .page-header-img {
                width: 100%;
                max-width: 15cm;
                height: 3cm;
                margin: -1cm auto 0.5cm;
            }
            
            .letter-header {
                flex-direction: column;
                gap: 0.25cm;
                margin-bottom: 0.75cm;
                font-size: 1.0em;
            }
            
            .stamp-container {
                right: 0.5cm;
                width: 170px;
                height: 140px;
                top: -0.4cm;
            }
        }
        
        @media (max-width: 480px) {
            .page {
                padding: 0.75cm;
                font-size: 13px;
            }
            
            .page-header-img {
                height: 2.5cm;
            }
            
            .letter-header {
                font-size: 0.9em;
            }
            
            .stamp-container {
                right: 0.25cm;
                width: 150px;
                height: 120px;
                top: -0.3cm;
            }
        }

        /* --- TEMPLATE STYLES --- */
        .template-classic { font-family: 'Times New Roman', Times, serif; }
        .template-classic .page { border: 1px solid #333; }

        .template-modern { font-family: Arial, Helvetica, sans-serif; }
        .template-modern .letter-header { font-family: sans-serif; }
        .template-modern h3 { border-bottom: 2px solid var(--primary-color); text-decoration: none; padding-bottom: 5px; }

        .template-minimal { font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif; line-height: 2; }

        .template-bordered .page { border: 10px double #333; padding: 2.5cm; }

        /* --- TOAST NOTIFICATION --- */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        }
        
        .toast {
            background: var(--white);
            color: var(--text-color);
            padding: 1rem 1.25rem;
            border-radius: var(--border-radius);
            margin-bottom: 0.75rem;
            box-shadow: var(--shadow-heavy);
            opacity: 0;
            transition: var(--transition);
            transform: translateX(100%);
            border-left: 4px solid var(--medium-gray);
            font-family: var(--font-family);
            font-size: 0.875rem;
            line-height: 1.4;
            backdrop-filter: blur(10px);
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .toast.success { 
            border-left-color: var(--success-color);
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.1) 0%, var(--white) 100%);
        }
        
        .toast.error { 
            border-left-color: var(--danger-color);
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.1) 0%, var(--white) 100%);
        }
        
        .toast.info { 
            border-left-color: var(--primary-color);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, var(--white) 100%);
        }
        
        /* Mobile toast adjustments */
        @media (max-width: 768px) {
            #toast-container {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
            
            .toast {
                padding: 0.875rem 1rem;
                font-size: 0.8rem;
            }
        }

        /* --- PRINT STYLES --- */
        @media print {
            @page {
                size: A4;
                margin: 0;
            }
            
            body, html {
                background: #fff;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            
            .no-print, .navbar, #viewGenerate > .grid-2 > div:first-child, .preview-container {
                display: none !important;
            }
            
            .main-content {
                padding: 0;
                overflow: visible;
            }
            
            .page {
                margin: 0;
                box-shadow: none;
                border: none;
                width: 21cm;
                height: 29.7cm;
                page-break-after: avoid;
                page-break-inside: avoid;
                overflow: hidden;
            }
            
            .page.single-page {
                width: 21cm !important;
                height: 29.7cm !important;
                max-height: 29.7cm !important;
                padding: 0.5cm 1cm !important;
                font-size: 12px !important;
                line-height: 1.3 !important;
                overflow: hidden !important;
                page-break-after: avoid !important;
                page-break-inside: avoid !important;
                transform: scale(1) !important;
                transform-origin: top left !important;
            }
            
            .single-page .page-header-img {
                height: 2cm !important;
                margin: 0 auto 0.1cm !important;
                max-width: 19cm !important;
            }
            
            .single-page .letter-header {
                margin-bottom: 0.2cm !important;
                font-size: 0.9em !important;
            }
            
            .single-page .letter-body {
                line-height: 1.2 !important;
                font-size: 1.0em !important;
            }
            
            .single-page .letter-body h3 {
                margin-bottom: 0.2cm !important;
                font-size: 1.1rem !important;
            }
            
            .single-page .letter-body h4 {
                margin-top: 0.3cm !important;
                margin-bottom: 0.2cm !important;
                font-size: 1.0rem !important;
            }
            
            .single-page .letter-body p {
                margin-bottom: 0.15cm !important;
            }
            
            .single-page .letter-body .payment-details,
            .single-page .letter-body .important-note,
            .single-page .letter-body .congratulations {
                padding: 0.2cm !important;
                margin: 0.2cm 0 !important;
            }
            
            .single-page .letter-body .details-block {
                margin: 0.25cm 0 !important;
            }
            
            .single-page .letter-footer {
                margin-top: 0.3cm !important;
            }
            
            .single-page .signature-spacing {
                margin-top: 0.25cm !important;
            }
            
            .single-page .stamp-container {
                width: 120px !important;
                height: 100px !important;
                right: 0.5cm !important;
                top: -0.2cm !important;
            }
            
            .print-only {
                display: block !important;
            }
            
            #previewAdmission, #previewBursary {
                display: none;
            }
            
            #print-area {
                display: block !important;
            }
            
            /* Hide requirements page when printing - multiple selectors for safety */
            .requirements-page,
            .page.requirements-page,
            div.requirements-page,
            .A4.requirements-page {
                display: none !important;
                visibility: hidden !important;
                height: 0 !important;
                overflow: hidden !important;
                page-break-before: avoid !important;
                page-break-after: avoid !important;
            }
            
            /* Ensure only first page prints for admission */
            .page.A4:nth-child(2) {
                display: none !important;
            }
            
            /* Ensure colors print properly */
            .congratulations,
            .important-note,
            .payment-details {
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            
            /* Ensure all content is visible during print */
            * {
                visibility: visible !important;
                display: block !important;
            }
            
            /* But hide specific UI elements */
            .no-print, .navbar, .preview-container {
                display: none !important;
            }
        }

        #print-area {
            display: none;
        }

        /* --- LOADING STATES --- */
        .loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid var(--medium-gray);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- MOBILE OPTIMIZATIONS --- */
        @media (max-width: 768px) {
            /* Improve scrolling on mobile */
            .main-content {
                -webkit-overflow-scrolling: touch;
                overflow-y: auto;
            }
            
            /* Better touch targets */
            .nav-tab {
                min-height: 48px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            /* Improve form usability on mobile */
            input, select, textarea {
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            /* Better mobile preview */
            .preview-container {
                border-radius: 0;
                margin: 0 -1rem;
            }
        }

        @media (max-width: 480px) {
            /* Ultra-small screen optimizations */
            .card-header {
                font-size: 1.125rem;
                padding-bottom: 0.75rem;
            }
            
            .form-group {
                margin-bottom: 1rem;
            }
            
            .grid-2,
            .grid-3 {
                gap: 0.75rem;
            }
        }
    </style>
</head>
<body>

    <!-- Login View -->
    <div id="loginView">
        <div class="login-card">
            <h1>EAVI System</h1>
            <p>Select your campus to access the system</p>
            <div class="input-group">
                <label for="adminType">Select Campus</label>
                <select id="adminType" required>
                    <option value="">Choose Campus...</option>
                    <option value="west">West Campus Admin</option>
                    <option value="town">Town Campus Admin</option>
                </select>
            </div>
            <button id="loginBtn">Login</button>
            <p id="loginError"></p>
        </div>
    </div>

    <!-- Main Application View -->
    <div id="appView" class="hidden">
        <nav class="navbar">
            <div class="navbar-brand">EAVI</div>
            <div class="nav-tabs">
                <div class="nav-tab active" id="tabDashboard" data-view="viewDashboard">Dashboard</div>
                <div class="nav-tab" id="tabGenerate" data-view="viewGenerate">Generate</div>
                <div class="nav-tab" id="tabReports" data-view="viewReports">View Reports</div>
                <div class="nav-tab" id="tabStudents" data-view="viewStudents">Student List</div>
                <div class="nav-tab" id="tabAnalysis" data-view="viewAnalysis">Analysis</div>
                <div class="nav-tab" id="tabSettings" data-view="viewSettings">Settings</div>
                <div class="nav-tab" id="tabBackup" data-view="viewBackup">Backup/Restore</div>
            </div>
            <div style="display: flex; align-items: center; gap: 1rem;" class="navbar-right">
                <span id="adminInfo" style="color: var(--dark-gray); font-size: 0.9rem;"></span>
                <button id="logoutBtn">Logout</button>
            </div>
        </nav>

        <main class="main-content">
            <!-- Dashboard View -->
            <div id="viewDashboard" class="view-content">
                <div class="card">
                    <h2 class="card-header">Dashboard</h2>
                    <p>Welcome to the EAVI Admission & Bursary System. Quick stats will be shown here.</p>
                </div>
            </div>

            <!-- Generate View -->
            <div id="viewGenerate" class="view-content hidden">
                <div class="card">
                    <h2 class="card-header">Student Information Entry</h2>
                    <input type="hidden" id="currentDeptRequirements">
                    <input type="hidden" id="editingStudentId">
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="inpName">Student Full Name</label>
                            <input type="text" id="inpName" required>
                        </div>
                        <div class="form-group">
                            <label for="inpAdmNo">Admission Number</label>
                            <input type="text" id="inpAdmNo" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="inpCourse">Course</label>
                        <select id="inpCourse" required></select>
                    </div>
                    <div class="form-group">
                        <label for="inpReportDate">Reporting Date</label>
                        <input type="date" id="inpReportDate" required>
                    </div>
                    
                    <h3 style="margin-top: 2rem; color: var(--secondary-color); border-bottom: 2px solid var(--medium-gray); padding-bottom: 0.5rem;">📋 Bursary Information</h3>
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="inpFeeBalance">Fee Balance (KES)</label>
                            <input type="number" id="inpFeeBalance" value="0">
                        </div>
                        <div class="form-group">
                            <label for="inpTotalPerTerm">Total Fees per Term (KES)</label>
                            <input type="number" id="inpTotalPerTerm" value="0">
                        </div>
                    </div>

                    <h3 style="margin-top: 2rem; color: var(--secondary-color); border-bottom: 2px solid var(--medium-gray); padding-bottom: 0.5rem;">🎨 Document Settings</h3>
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="templateSelect">Template Style</label>
                            <select id="templateSelect">
                                <option value="classic">Classic</option>
                                <option value="modern">Modern</option>
                                <option value="minimal">Minimal</option>
                                <option value="bordered">Bordered</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Permanent Assets</label>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem;">
                                <p style="color: var(--success-color); font-size: 0.9rem; margin: 0;">✓ Header: image.png loaded</p>
                                <p style="color: var(--success-color); font-size: 0.9rem; margin: 0;">✓ Stamp: stamp.png loaded</p>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--medium-gray);">
                        <div class="btn-group">
                            <button id="btnGenerate" class="btn btn-primary" style="padding: 1rem 2rem; font-size: 1.1rem;">📄 Generate Letters & Save Record</button>
                            <button id="btnResetForm" class="btn btn-secondary">🔄 Reset Form</button>
                        </div>
                        <p style="margin-top: 1rem; color: var(--text-light); font-size: 0.9rem;">Clicking 'Generate' will create both admission and bursary letters, save the student record, and take you to the view page.</p>
                    </div>
                </div>
            </div>

            <!-- View Reports -->
            <div id="viewReports" class="view-content hidden">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 class="card-header" style="margin-bottom: 0;">📋 Generated Letters - <span id="studentNameDisplay">Student Name</span></h2>
                        <button id="btnBackToGenerate" class="btn btn-secondary">← Back to Generate</button>
                    </div>
                    
                    <div class="indicator">
                        <strong>Student:</strong> <span id="studentDetailsDisplay">Student details will appear here</span>
                    </div>

                    <div class="grid-2" style="gap: 2rem;">
                        <!-- Admission Letter Section -->
                        <div class="card" style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);">
                            <h3 style="color: var(--primary-color); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                🎓 <span>Admission Letter</span>
                            </h3>
                            <div id="admissionPreviewContainer" style="max-height: 400px; overflow-y: auto; border: 2px solid var(--medium-gray); border-radius: var(--border-radius); background: white;">
                                <div id="previewAdmission"><!-- Admission letter preview will be rendered here --></div>
                            </div>
                            <div id="admissionActions" class="btn-group hidden" style="margin-top: 1rem;">
                                <button id="btnPrintAdmission" class="btn btn-sm btn-secondary">🖨️ Print</button>
                                <button id="btnPdfAdmission" class="btn btn-sm btn-success">📄 Download PDF</button>
                                <button id="btnShareWhatsappAdmission" class="btn btn-sm btn-primary">📱 Share All Documents</button>
                            </div>
                        </div>

                        <!-- Bursary Letter Section -->
                        <div class="card" style="background: linear-gradient(135deg, #fff3e0 0%, #f1f8e9 100%);">
                            <h3 style="color: var(--accent-color); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                💰 <span>Bursary Letter</span>
                            </h3>
                            <div id="bursaryPreviewContainer" style="max-height: 400px; overflow-y: auto; border: 2px solid var(--medium-gray); border-radius: var(--border-radius); background: white;">
                                <div id="previewBursary"><!-- Bursary letter preview will be rendered here --></div>
                            </div>
                            <div id="bursaryActions" class="btn-group hidden" style="margin-top: 1rem;">
                                <button id="btnPrintBursary" class="btn btn-sm btn-secondary">🖨️ Print</button>
                                <button id="btnPdfBursary" class="btn btn-sm btn-success">📄 Download PDF</button>
                                <button id="btnShareWhatsappBursary" class="btn btn-sm btn-primary">📱 Share All Documents</button>
                            </div>
                        </div>
                    </div>

                    <!-- Fee Structure Section -->
                    <div class="card" id="feeStructureSection" style="margin-top: 2rem; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); display: none;">
                        <h3 style="color: var(--dark-gray); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            💳 <span>Fee Structure</span>
                        </h3>
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <p id="feeStructureInfo">Fee structure information will appear here</p>
                            <button id="btnDownloadFeeStructure" class="btn btn-sm btn-success">📄 Download Fee Structure</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Student List View -->
            <div id="viewStudents" class="view-content hidden">
                <div class="card">
                    <h2 class="card-header">Student List</h2>
                    <div id="campusIndicator" class="indicator">
                        <strong>Campus:</strong> <span id="currentCampusDisplay">All Campuses</span>
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="studentSearch">Search by Name or Admission No.</label>
                            <input type="text" id="studentSearch" placeholder="Start typing to search...">
                        </div>
                        <div class="form-group">
                            <label for="studentYearFilter">Filter by Year</label>
                            <select id="studentYearFilter"></select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="studentsTable">
                            <thead>
                                <tr>
                                    <th>Ref No</th>
                                    <th>Name</th>
                                    <th>Adm No</th>
                                    <th>Course</th>
                                    <th>Campus</th>
                                    <th>Report Date</th>
                                    <th>Year</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Student rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Analysis View -->
            <div id="viewAnalysis" class="view-content hidden">
                <div class="card">
                    <h2 class="card-header">Analysis & Reports</h2>
                    <div id="analysisIndicator" style="background: var(--light-gray); padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1.5rem; border-left: 4px solid var(--accent-color);">
                        <strong>Showing data for:</strong> <span id="analysisCampusDisplay">All Campuses</span>
                    </div>
                    <div class="grid-2">
                        <div class="chart-container">
                            <h3>Admissions per Year</h3>
                            <canvas id="admissionsPerYearChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>Admissions by Course</h3>
                            <canvas id="admissionsByDeptChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="viewSettings" class="view-content hidden">
                <div class="card" style="max-width: 800px; margin: 0 auto;">
                    <h2 class="card-header">Courses & Fee Structure</h2>
                    <p style="margin-bottom: 2rem; color: var(--dark-gray);"><strong>Fee Structure Rule:</strong> All fee structure files are loaded directly from the <code>fees/</code> folder in your project. To add a course, select the corresponding fee structure PDF from the dropdown. Files must be placed in the fees/ directory for them to appear in the selection.</p>
                    
                    <div class="card" style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); margin-bottom: 2rem; border-left: 4px solid var(--success-color);">
                        <h3 style="color: var(--success-color); margin-bottom: 1rem;">📁 Fee Structure Files Location</h3>
                        <p style="margin-bottom: 1rem;"><strong>Files are loaded from:</strong> <code>fees/</code> folder</p>
                        <p style="margin-bottom: 1rem;"><strong>Current files available:</strong> 11 PDF files detected</p>
                        <p><strong>Note:</strong> Fee structure files are never stored in the database - they are always loaded directly from the fees/ folder to ensure data integrity and easy file management.</p>
                    </div>
                    
                    <!-- Course Addition Helper -->
                    <div class="card" style="background: linear-gradient(135deg, var(--light-gray) 0%, #f1f5f9 100%); margin-bottom: 2rem; border-left: 4px solid var(--primary-color);">
                        <h3 style="color: var(--primary-color); margin-bottom: 1rem;">📚 Add New Course Collection</h3>
                        <p style="margin-bottom: 1rem;">Click the button below to add all the latest courses to your system. This will only add courses that don't already exist.</p>
                        <button id="addNewCoursesBtn" class="btn btn-primary">Add All New Courses (70+ courses)</button>
                    </div>
                    
                    <form id="courseForm">
                        <input type="hidden" id="editingCourseId">
                        <div class="form-group">
                            <label for="courseName">Course Name</label>
                            <input type="text" id="courseName" required>
                        </div>
                        <div class="form-group">
                            <label for="courseFeeStructureSelect">Fee Structure (Select from fees/ folder) <span style="color: red;">*</span></label>
                            <select id="courseFeeStructureSelect" required>
                                <option value="">Select a fee structure PDF...</option>
                            </select>
                            <small style="color: var(--dark-gray); display: block; margin-top: 0.5rem;">Select the course fee structure PDF from the fees/ folder. Files must be placed in the fees/ directory.</small>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Course</button>
                        <button type="button" id="cancelCourseEditBtn" class="btn btn-secondary hidden">Cancel Edit</button>
                    </form>
                    <table id="courseTable" style="margin-top: 2rem;">
                        <thead><tr><th>Course Name</th><th>Fee Structure</th><th>Actions</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Backup/Restore View -->
            <div id="viewBackup" class="view-content hidden">
                <div class="card">
                    <h2 class="card-header">Backup & Restore</h2>
                    <div class="grid-2">
                        <div>
                            <h3>Backup</h3>
                            <p>Download all application data (students, courses, settings) into a single JSON file.</p>
                            <button id="backupBtn" class="btn btn-success">Backup All Data</button>
                        </div>
                        <div>
                            <h3>Restore</h3>
                            <p>Restore data from a previously saved JSON file. <strong>Warning:</strong> This will overwrite all existing data.</p>
                            <input type="file" id="restoreFile" accept=".json">
                            <button id="restoreBtn" class="btn btn-danger" disabled>Restore from File</button>
                        </div>
                    </div>
                    <hr style="margin: 2rem 0; border-color: var(--medium-gray);">
                    <div>
                        <h3 style="color: var(--danger-color);">Danger Zone</h3>
                        <p>This action will permanently delete all students, departments, courses, and saved images. This cannot be undone.</p>
                        <br>
                        <button id="clearDataBtn" class="btn btn-danger">Clear All System Data</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <!-- Area for printing content -->
    <div id="print-area"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE & CONFIG ---
        const state = {
            db: null,
            headerImageDataUrl: null,
            stampImageDataUrl: null,
            currentStudentData: null,
            charts: {},
            currentAdmin: null // Track current admin type
        };

        const DB_NAME = 'eaviDB';
        const DB_VERSION = 1;

        // --- DOM ELEMENTS ---
        const loginView = document.getElementById('loginView');
        const appView = document.getElementById('appView');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const adminType = document.getElementById('adminType');
        const loginError = document.getElementById('loginError');

        const tabs = document.querySelectorAll('.nav-tab');
        const views = document.querySelectorAll('.view-content');

        // Generate Form
        const generateForm = {
            id: document.getElementById('editingStudentId'),
            requirements: document.getElementById('currentDeptRequirements'),
            name: document.getElementById('inpName'),
            admNo: document.getElementById('inpAdmNo'),
            course: document.getElementById('inpCourse'),
            reportDate: document.getElementById('inpReportDate'),
            feeBalance: document.getElementById('inpFeeBalance'),
            totalPerTerm: document.getElementById('inpTotalPerTerm'),
            template: document.getElementById('templateSelect'),
            btnGenerate: document.getElementById('btnGenerate'),
            btnReset: document.getElementById('btnResetForm'),
        };

        // Set minimum date for reporting date input to prevent past dates
        generateForm.reportDate.min = new Date().toISOString().split('T')[0];

        // Previews & Actions
        const previewAdmission = document.getElementById('previewAdmission');
        const previewBursary = document.getElementById('previewBursary');
        const admissionActions = document.getElementById('admissionActions');
        const bursaryActions = document.getElementById('bursaryActions');

        // --- INITIALIZATION ---
        function init() {
            if (sessionStorage.getItem('eaviAuth') === 'true') {
                // Restore admin info
                const adminInfo = sessionStorage.getItem('eaviAdmin');
                if (adminInfo) {
                    state.currentAdmin = JSON.parse(adminInfo);
                }
                showApp();
            } else {
                showLogin();
            }
        }

        async function showApp() {
            loginView.classList.add('hidden');
            appView.classList.remove('hidden');
            
            // Update admin info display
            const adminInfoEl = document.getElementById('adminInfo');
            if (state.currentAdmin && adminInfoEl) {
                adminInfoEl.textContent = `Logged in as: ${state.currentAdmin.displayName}`;
            }
            
            await initDB();
            await loadPermanentStamp();
            await loadPermanentHeader();
            await loadInitialData();
            setupEventListeners();
            navigateToView('viewDashboard');
        }

        function showLogin() {
            loginView.classList.remove('hidden');
            appView.classList.add('hidden');
            
            // Clear login form
            adminType.value = '';
            loginError.textContent = '';
            
            loginBtn.addEventListener('click', handleLogin, { once: true });
        }

        async function loadInitialData() {
            await loadPersistedSettings();
            await loadCoursesAndDepartments();
            await loadFeeStructureFiles();
            await loadStudentList();
            await updateDashboard();
        }

        // --- AUTHENTICATION ---

        function handleLogin() {
            const campusType = adminType.value.trim();
            
            // Clear previous error
            loginError.textContent = '';
            
            // Validate campus selection
            if (!campusType) {
                loginError.textContent = 'Please select a campus.';
                loginBtn.addEventListener('click', handleLogin, { once: true });
                return;
            }
            
            // Set admin info based on campus selection
            const campusInfo = {
                west: { displayName: 'West Campus Admin' },
                town: { displayName: 'Town Campus Admin' }
            };
            
            if (campusInfo[campusType]) {
                state.currentAdmin = {
                    type: campusType,
                    displayName: campusInfo[campusType].displayName
                };
                sessionStorage.setItem('eaviAuth', 'true');
                sessionStorage.setItem('eaviAdmin', JSON.stringify(state.currentAdmin));
                showApp();
            } else {
                loginError.textContent = 'Invalid campus selection.';
                loginBtn.addEventListener('click', handleLogin, { once: true });
            }
        }

        function handleLogout() {
            sessionStorage.removeItem('eaviAuth');
            sessionStorage.removeItem('eaviAdmin');
            state.currentAdmin = null;
            window.location.reload();
        }

        // --- DATABASE (IndexedDB) ---
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = (event) => {
                    console.error('Database error:', event.target.error);
                    showToast('Database could not be opened.', 'error');
                    reject('DB Error');
                };

                request.onsuccess = (event) => {
                    state.db = event.target.result;
                    console.log('Database opened successfully.');
                    resolve();
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // Students Store
                    if (!db.objectStoreNames.contains('students')) {
                        const studentsStore = db.createObjectStore('students', { keyPath: 'id', autoIncrement: true });
                        studentsStore.createIndex('refNo', 'refNo', { unique: true });
                        studentsStore.createIndex('name', 'name', { unique: false });
                        studentsStore.createIndex('admNo', 'admNo', { unique: true });
                        studentsStore.createIndex('year', 'year', { unique: false });
                    }

                    // Courses Store (no more departments)
                    if (!db.objectStoreNames.contains('courses')) {
                        const courseStore = db.createObjectStore('courses', { keyPath: 'id', autoIncrement: true });
                        courseStore.createIndex('name', 'name', { unique: true });
                    }

                    // Settings Store
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings', { keyPath: 'key' });
                    }

                    // Seed initial data
                    const transaction = event.target.transaction;
                    transaction.oncomplete = () => {
                        seedInitialData(db).then(resolve).catch(reject);
                    };
                };
            });
        }

        async function seedInitialData(db) {
            const courseTx = db.transaction('courses', 'readwrite');
            const courseStore = courseTx.objectStore('courses');
            
            // Check if courses already exist to avoid duplicates
            const existingCourses = await new Promise(resolve => {
                const request = courseStore.getAll();
                request.onsuccess = () => resolve(request.result);
            });
            
            if (existingCourses.length === 0) {
                const courses = [
                    // Medical and Healthcare Courses
                    { name: 'Peri-operative Theater Technology', feeStructurePdf: null },
                    { name: 'Orthopaedic and Trauma Medicine', feeStructurePdf: null },
                    { name: 'Dental Assistant', feeStructurePdf: null },
                    { name: 'Phlebotomy', feeStructurePdf: null },
                    { name: 'Certified Nurse Assistant (CNA)', feeStructurePdf: null },
                    { name: 'Morgue Attendant', feeStructurePdf: null },
                    { name: 'Basic Life Support (BLS)', feeStructurePdf: null },
                    { name: 'Mortuary Science', feeStructurePdf: null },
                    { name: 'Home Care Nursing', feeStructurePdf: null },
                    { name: 'Health Services Support', feeStructurePdf: null },
                    { name: 'Health Care Assistant', feeStructurePdf: null },
                    { name: 'Individual Support', feeStructurePdf: null },
                    { name: 'Caregiver', feeStructurePdf: null },
                    { name: 'Nurse Aide', feeStructurePdf: null },
                    { name: 'Patient Attendant', feeStructurePdf: null },
                    { name: 'Midwifery', feeStructurePdf: null },
                    { name: 'Community Health Assistant', feeStructurePdf: null },
                    { name: 'Public Health', feeStructurePdf: null },
                    { name: 'Nutrition and Dietetics', feeStructurePdf: null },
                    { name: 'Medical Engineering and Laboratory Technology', feeStructurePdf: null },
                    { name: 'Community Health and Social Work', feeStructurePdf: null },
                    { name: 'HIV/AIDS Management', feeStructurePdf: null },
                    { name: 'HIV/AIDS Testing & Counseling (HTC)', feeStructurePdf: null },
                    { name: 'First Aid', feeStructurePdf: null },
                    
                    // Social Services and Care
                    { name: 'Child Care and Protection', feeStructurePdf: null },
                    { name: 'Social Work and Nurse Aide', feeStructurePdf: null },
                    { name: 'Community Development and Social Work', feeStructurePdf: null },
                    { name: 'Gender and Development Studies', feeStructurePdf: null },
                    { name: 'Counseling', feeStructurePdf: null },
                    { name: 'Guidance and Counseling Skills Development', feeStructurePdf: null },
                    { name: 'Counseling Psychology', feeStructurePdf: null },
                    { name: 'Conflict Management and Peace Building', feeStructurePdf: null },
                    
                    // Beauty and Fashion
                    { name: 'Hairdressing and Beauty Therapy', feeStructurePdf: null },
                    { name: 'Fashion and Design', feeStructurePdf: null },
                    { name: 'Garment Making', feeStructurePdf: null },
                    
                    // Administrative and Office Skills
                    { name: 'Secretarial', feeStructurePdf: null },
                    { name: 'Health Records Management with ICT', feeStructurePdf: null },
                    { name: 'Computer Packages / IT / ICT / Information Science', feeStructurePdf: null },
                    { name: 'Public Administration and Relations', feeStructurePdf: null },
                    { name: 'Customer Care / Front Office Management', feeStructurePdf: null },
                    
                    // Education and Training
                    { name: 'Teacher Education', feeStructurePdf: null },
                    { name: 'Leadership Skills Development', feeStructurePdf: null },
                    { name: 'Training of Trainers (TOT)', feeStructurePdf: null },
                    
                    // Engineering and Technical
                    { name: 'Security Management', feeStructurePdf: null },
                    { name: 'Electrical Engineering, Civil / Building / Survey', feeStructurePdf: null },
                    { name: 'Water Engineering / Plumbing, Mechanical / Automotive', feeStructurePdf: null },
                    
                    // Hospitality and Food Services
                    { name: 'Catering / Food and Beverage Management', feeStructurePdf: null },
                    { name: 'Culinary Arts', feeStructurePdf: null },
                    { name: 'Hotel and Hospitality Management', feeStructurePdf: null },
                    { name: 'Tourism Management', feeStructurePdf: null },
                    
                    // Business and Management
                    { name: 'Store Keeping', feeStructurePdf: null },
                    { name: 'Purchasing & Supply Management', feeStructurePdf: null },
                    { name: 'NGO Management', feeStructurePdf: null },
                    { name: 'Logistics and Procurement Management', feeStructurePdf: null },
                    { name: 'Human Resource Management (HRM)', feeStructurePdf: null },
                    { name: 'Business Administration and Management', feeStructurePdf: null },
                    { name: 'Finance & Banking', feeStructurePdf: null },
                    { name: 'Sales and Marketing', feeStructurePdf: null },
                    { name: 'Entrepreneurship', feeStructurePdf: null },
                    { name: 'Financial Management for NGOs', feeStructurePdf: null },
                    
                    // Specialized Skills
                    { name: 'General Agriculture', feeStructurePdf: null },
                    { name: 'Criminology', feeStructurePdf: null },
                    { name: 'Nutrition Management Skills', feeStructurePdf: null },
                    { name: 'Monitoring and Evaluation of Projects', feeStructurePdf: null },
                    { name: 'Disaster Management', feeStructurePdf: null },
                    
                    // Legacy courses (keeping for existing data compatibility)
                    { name: 'Diploma in Accounting', feeStructurePdf: null },
                    { name: 'Certificate in ICT', feeStructurePdf: null },
                    { name: 'Certificate in Hospitality', feeStructurePdf: null }
                ];
                
                for (const course of courses) {
                    courseStore.add(course);
                }
                console.log(`${courses.length} courses seeded successfully.`);
            } else {
                console.log('Courses already exist, skipping seed data.');
            }
            
            await new Promise(resolve => courseTx.oncomplete = resolve);
        }

        function getFromDB(store, indexName, value) {
            return new Promise((resolve, reject) => {
                const index = store.index(indexName);
                const request = index.get(value);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        function getByIdFromDB(storeName, id) {
            return new Promise((resolve, reject) => {
                const transaction = state.db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(id);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        function getFromDBByKey(storeName, key) {
            return new Promise((resolve, reject) => {
                const transaction = state.db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        function getAllFromDB(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = state.db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        function addToDB(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = state.db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        function updateInDB(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = state.db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        function deleteFromDB(storeName, id) {
            return new Promise((resolve, reject) => {
                const transaction = state.db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e.target.error);
            });
        }

        // --- NAVIGATION ---
        function setupEventListeners() {
            logoutBtn.addEventListener('click', handleLogout);

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const viewId = tab.dataset.view;
                    navigateToView(viewId);
                });
            });

            // Generate Form Listeners
            generateForm.course.addEventListener('change', handleCourseChange);
            generateForm.template.addEventListener('change', () => {
                applyTemplateStyle();
                // Clear PDF cache when template changes
                if (state.currentStudentData) {
                    pdfCache.admission = null;
                    pdfCache.bursary = null;
                    pdfCache.lastStudentId = null;
                    // Regenerate cache after template change
                    setTimeout(() => {
                        generatePDFsForSharing().catch(error => {
                            console.warn('Failed to regenerate PDFs after template change:', error);
                        });
                    }, 1000);
                }
            });
            generateForm.btnGenerate.addEventListener('click', handleGenerate);
            generateForm.btnReset.addEventListener('click', resetGenerateForm);
            
            // View Reports Listeners
            document.getElementById('btnBackToGenerate').addEventListener('click', () => {
                navigateToView('viewGenerate');
            });
            document.getElementById('btnDownloadFeeStructure').addEventListener('click', downloadCurrentFeeStructure);

            // Export/Share Listeners
            document.getElementById('btnPrintAdmission').addEventListener('click', () => printDocument('Admission'));
            document.getElementById('btnPdfAdmission').addEventListener('click', () => exportAsPDF('Admission'));
            document.getElementById('btnShareWhatsappAdmission').addEventListener('click', () => shareViaWhatsApp('Admission'));

            document.getElementById('btnPrintBursary').addEventListener('click', () => printDocument('Bursary'));
            document.getElementById('btnPdfBursary').addEventListener('click', () => exportAsPDF('Bursary'));
            document.getElementById('btnShareWhatsappBursary').addEventListener('click', () => shareViaWhatsApp('Bursary'));

            // Student List Listeners
            document.getElementById('studentSearch').addEventListener('input', loadStudentList);
            document.getElementById('studentYearFilter').addEventListener('change', loadStudentList);

            // Settings Listeners
            document.getElementById('courseForm').addEventListener('submit', handleAddCourse);
            document.getElementById('courseTable').addEventListener('click', handleCourseTableClick);
            document.getElementById('cancelCourseEditBtn').addEventListener('click', resetCourseForm);
            document.getElementById('addNewCoursesBtn').addEventListener('click', addNewCoursesToExistingDB);

            // Backup/Restore Listeners
            document.getElementById('backupBtn').addEventListener('click', backupAllData);
            document.getElementById('restoreFile').addEventListener('change', (e) => {
                document.getElementById('restoreBtn').disabled = !e.target.files.length;
            });
            document.getElementById('restoreBtn').addEventListener('click', handleRestore);
            document.getElementById('clearDataBtn').addEventListener('click', handleClearAllData);
        }

        function navigateToView(viewId) {
            views.forEach(view => view.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');

            tabs.forEach(t => t.classList.remove('active'));
            document.querySelector(`.nav-tab[data-view="${viewId}"]`).classList.add('active');

            // Refresh data for specific views
            if (viewId === 'viewStudents') loadStudentList();
            if (viewId === 'viewAnalysis') updateAnalysisCharts();
            if (viewId === 'viewDashboard') updateDashboard();
            if (viewId === 'viewSettings') {
                loadCoursesAndDepartments();
                loadFeeStructureFiles();
            }
        }

        // --- GENERATE & PREVIEW LOGIC ---
        async function handleGenerate() {
            if (!validateForm()) return;

            try {
                const refNo = await generateRefNo();
                const currentDate = formatDate(new Date());
                const selectedCourseOption = generateForm.course.options[generateForm.course.selectedIndex];

                const studentData = {
                    id: generateForm.id.value ? parseInt(generateForm.id.value) : undefined,
                    name: generateForm.name.value.trim(),
                    admNo: generateForm.admNo.value.trim(),
                    courseId: parseInt(generateForm.course.value),
                    courseName: selectedCourseOption.text,
                    courseRequirements: generateForm.requirements.value,
                    reportDate: generateForm.reportDate.value,
                    feeBalance: parseFloat(generateForm.feeBalance.value) || 0,
                    totalPerTerm: parseFloat(generateForm.totalPerTerm.value) || 0,
                    refNo: refNo,
                    createdAt: new Date().toISOString(),
                    year: new Date(generateForm.reportDate.value).getFullYear(),
                    template: generateForm.template.value,
                    headerImg: state.headerImageDataUrl,
                    stampImg: state.stampImageDataUrl,
                    currentDate: currentDate,
                    campus: state.currentAdmin ? state.currentAdmin.type : 'unknown',
                    campusName: state.currentAdmin ? state.currentAdmin.displayName : 'Unknown Campus'
                };

                // Show loading state
                generateForm.btnGenerate.disabled = true;
                generateForm.btnGenerate.textContent = 'Saving...';
                showToast('Saving student record...', 'info');

                const savedId = await saveStudentRecord(studentData);
                studentData.id = savedId;
                state.currentStudentData = studentData;

                renderAdmissionPages(studentData);
                renderBursaryPage(studentData);
                applyTemplateStyle();

                // Pre-generate PDFs for sharing after documents are rendered
                setTimeout(() => {
                    generatePDFsForSharing().catch(error => {
                        console.warn('Failed to pre-generate PDFs for sharing:', error);
                    });
                }, 1000); // Small delay to ensure DOM is fully rendered

                // Update the view reports page with student info
                updateViewReportsPage(studentData);
                
                // Navigate to view reports
                navigateToView('viewReports');

                showToast(generateForm.id.value ? 'Student record updated successfully!' : 'Student record saved successfully!', 'success');
                
                // Reset button state
                generateForm.btnGenerate.disabled = false;
                generateForm.btnGenerate.textContent = generateForm.id.value ? 'Update Record' : 'Generate & Save';
                
            } catch (error) {
                console.error('Error saving student:', error);
                generateForm.btnGenerate.disabled = false;
                generateForm.btnGenerate.textContent = generateForm.id.value ? 'Update Record' : 'Generate & Save';
                
                if (error.message && error.message.includes('admNo')) {
                    showToast('Error: Admission number already exists. Please use a different admission number.', 'error');
                } else {
                    showToast(`Error saving student record: ${error.message || 'Unknown error'}`, 'error');
                }
            }
        }

        function validateForm() {
            let isValid = true;
            const requiredFields = [generateForm.name, generateForm.admNo, generateForm.course, generateForm.reportDate];
            requiredFields.forEach(field => {
                if (!field.value) {
                    field.style.borderColor = 'red';
                    isValid = false;
                } else {
                    field.style.borderColor = '';
                }
            });
            if (!isValid) showToast('Please fill all required fields.', 'error');
            return isValid;
        }

        function renderAdmissionPages(data) {
            const requirementsList = data.courseRequirements.split('\n').map(item => `<li>${item}</li>`).join('');

            // Determine paybill number based on campus
            const paybillNumber = data.campus === 'west' ? '4129827' : '257557';
            const campusName = data.campus === 'west' ? 'West Campus' : 'Town Campus';

            previewAdmission.innerHTML = `
                <div class="page A4">
                    ${renderHeader(data)}
                    <div class="letter-body">
                        <p>Dear Sir/Madam,</p>
                        <br>
                        <h3>RE: ADMISSION LETTER</h3>
                        <br>
                        <p>Name: <span class="student-name">${data.name.toUpperCase()}</span></p>
                        
                        <div class="congratulations">
                            <p><strong>Congratulations!</strong> We are pleased to inform you that, with the approval of the Board of Directors, you have been admitted as a student of <strong>East Africa Vision Institute (EAVI)</strong>.</p>
                        </div>
                        
                        <p>You have been admitted for <span class="course-name">${data.courseName.toUpperCase()}</span>, with Admission Number: <span class="admission-number">${data.admNo.toUpperCase()}</span>.</p>
                        
                        <p>You are required to report to the Institute on <span class="reporting-date">${formatDate(new Date(data.reportDate))}</span>.</p>
                        
                        <div class="important-note">
                            <p><strong>Note:</strong> You are required to report immediately.</p>
                        </div>
                        
                        <h4>Fee Payment Details</h4>
                        <div class="payment-details">
                            <p><strong>East Africa Vision Institute</strong><br>
                            <strong>Equity Bank:</strong> Account No. <span class="fee-amount">0470292838961</span><br>
                            <strong>KCB Bank:</strong> Account No. <span class="fee-amount">1115207350</span><br>
                            <strong>M-PESA Paybill:</strong> <span class="fee-amount">${paybillNumber}</span>, Account Number: <span class="student-name">${data.name.toUpperCase()}</span></p>
                        </div>
                        
                        <div class="important-note">
                            <p><strong>Important:</strong> We do not accept cash payments. All fees must be deposited in the above accounts only.</p>
                        </div>
                        
                        <div class="letter-footer">
                            <p class="signature-section">Yours faithfully,</p>
                            ${renderStamp(data)}
                            <div class="signature-section signature-spacing">
                                <p><strong>TRIZAH JUMA</strong><br>
                                For Directors:<br>
                                Philemon Saina (B.Sc. Eng, MBA)<br>
                                Beth Mwangi (B.A, MBA, PhD Finance)<br>
                                R. B. Patel (B.Sc. Eng, M.Sc.)</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="page A4 requirements-page">
                    <div class="letter-body">
                        <h3>REQUIREMENTS</h3>
                        <ul>${requirementsList}</ul>
                    </div>
                </div>
            `;
        }

        function renderBursaryPage(data) {
            previewBursary.innerHTML = `
                <div class="page A4">
                    ${renderHeader(data)}
                    <div class="letter-body">
                        <p><strong>THE CHAIRPERSON</strong><br><span style="font-weight: bold;">BURSARY COMMITTEE</span></p>
                        <br>
                        <p>Dear Sir/Madam,</p>
                        <br>
                        <h3>RE: BURSARY SUPPORT REQUEST</h3>
                        
                        <div class="details-block">
                            <p>Name: <span class="student-name">${data.name.toUpperCase()}</span><br>
                            The above named student, Adm. No: <span class="admission-number">${data.admNo.toUpperCase()}</span><br>                        
                            Enrolled for <span class="course-name">${data.courseName.toUpperCase()}</span></p>
                        </div>
                        
                        <div class="important-note">
                            <p>Due to financial difficulty, the student is not able to continue/start the course immediately; therefore we request that you give this student school fee support.</p>
                        </div>
                        
                        <p>The student has a fee balance of <span class="fee-amount">KES ${data.feeBalance.toLocaleString()}</span>. The total fees per term is <span class="fee-amount">KES ${data.totalPerTerm.toLocaleString()}</span>.</p>
                        
                        <h4>Fee Payment Details</h4>
                        <div class="payment-details">
                            <p><strong>East Africa Vision Institute</strong><br>
                            <strong>Equity Bank:</strong> Account No. <span class="fee-amount">0470292838961</span><br>
                            <strong>KCB Bank:</strong> Account No. <span class="fee-amount">1115207350</span></p>
                        </div>
                        
                        <div class="congratulations">
                            <p>I believe you will consider his/her request. Thank you in advance for your kind consideration.</p>
                        </div>

                        <div class="letter-footer">
                            <p class="signature-section">Yours faithfully,</p>
                            ${renderStamp(data)}
                            <div class="signature-section signature-spacing">
                                <p>For College Principal<br><strong>Trizah Juma</strong></p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderHeader(data) {
            return `
                ${data.headerImg ? `<img src="${data.headerImg}" class="page-header-img">` : '<div class="page-header-img" style="text-align:center; border:1px dashed #ccc; display:flex; align-items:center; justify-content:center; background-color:#f9f9f9;">Header Image Area (15cm x 4cm)</div>'}
                <div class="letter-header">
                    <span>OUR REF: ${data.refNo}</span>
                    <span>DATE: ${data.currentDate}</span>
                </div>
            `;
        }

        function renderStamp(data) {
            return `
                <div class="stamp-container">
                    ${data.stampImg ? `<img src="${data.stampImg}" class="stamp-img">` : '<div style="width:220px; height:180px; border:1px dashed #ccc; display:flex; align-items:center; justify-content:center;">Stamp Area</div>'}
                </div>
            `;
        }

        function applyTemplateStyle() {
            const templateKey = generateForm.template.value;
            const previews = [previewAdmission, previewBursary];
            previews.forEach(preview => {
                preview.classList.remove('template-classic', 'template-modern', 'template-minimal', 'template-bordered');
                if (templateKey) {
                    preview.classList.add(`template-${templateKey}`);
                }
            });
        }

        async function handleCourseChange() {
            const courseId = parseInt(generateForm.course.value);
            generateForm.requirements.value = ''; // Clear previous

            if (!courseId) {
                return;
            }

            try {
                const course = await getByIdFromDB('courses', courseId);
                if (course && course.feeStructurePdf && course.feeStructureFileName) {
                    // Set a placeholder text indicating fee structure is available from fees/ folder
                    generateForm.requirements.value = `Fee structure available: ${course.feeStructureFileName} (from fees/ folder)`;
                } else {
                    generateForm.requirements.value = 'No fee structure uploaded for this course';
                }
            } catch (error) {
                console.error("Error fetching course fee structure:", error);
            }
        }

        function resetGenerateForm() {
            generateForm.id.value = '';
            generateForm.name.value = '';
            generateForm.admNo.value = '';
            generateForm.course.value = '';
            generateForm.requirements.value = '';
            generateForm.reportDate.value = '';
            generateForm.feeBalance.value = '0';
            generateForm.totalPerTerm.value = '0';
            generateForm.btnGenerate.textContent = 'Generate & Save';
            previewAdmission.innerHTML = '';
            previewBursary.innerHTML = '';
            state.currentStudentData = null;
            showToast('Form cleared.', 'success');
        }

        // --- VIEW REPORTS PAGE FUNCTIONS ---
        function updateViewReportsPage(studentData) {
            // Update student name and details
            document.getElementById('studentNameDisplay').textContent = studentData.name;
            document.getElementById('studentDetailsDisplay').innerHTML = `
                <strong>Name:</strong> ${studentData.name} | 
                <strong>Adm No:</strong> ${studentData.admNo} | 
                <strong>Course:</strong> ${studentData.courseName} | 
                <strong>Campus:</strong> ${studentData.campusName}
            `;
            
            // Show action buttons
            document.getElementById('admissionActions').classList.remove('hidden');
            document.getElementById('bursaryActions').classList.remove('hidden');
            
            // Show fee structure section if available
            showFeeStructureSection(studentData.courseId);
        }
        
        async function showFeeStructureSection(courseId) {
            try {
                const course = await getByIdFromDB('courses', courseId);
                const feeStructureSection = document.getElementById('feeStructureSection');
                
                if (course && course.feeStructurePdf) {
                    document.getElementById('feeStructureInfo').textContent = 
                        `Fee structure available: ${course.feeStructureFileName || course.name + '_fee_structure.pdf'} (loaded from fees/ folder)`;
                    feeStructureSection.style.display = 'block';
                } else {
                    feeStructureSection.style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking fee structure:', error);
            }
        }
        
        async function downloadCurrentFeeStructure() {
            if (!state.currentStudentData) return;
            
            try {
                const course = await getByIdFromDB('courses', state.currentStudentData.courseId);
                if (course && course.feeStructurePdf) {
                    const link = document.createElement('a');
                    link.href = course.feeStructurePdf; // This will be 'fees/filename.pdf'
                    link.download = course.feeStructureFileName || `Fees-${course.name.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showToast('Fee structure downloaded from fees/ folder.', 'success');
                } else {
                    showToast('No fee structure available for this course.', 'error');
                }
            } catch (error) {
                console.error('Error downloading fee structure:', error);
                showToast('Error downloading fee structure from fees/ folder.', 'error');
            }
        }

        // --- DATA HELPERS ---
        async function generateRefNo() {
            const transaction = state.db.transaction('students', 'readonly');
            const store = transaction.objectStore('students');
            const index = store.index('refNo');
            const request = index.openCursor(null, 'prev');
            
            return new Promise(resolve => {
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    let lastNum = 0;
                    if (cursor) {
                        const lastRef = cursor.value.refNo;
                        lastNum = parseInt(lastRef.split('/').pop());
                    }
                    const newNum = (lastNum + 1).toString().padStart(4, '0');
                    resolve(`EAVI/8833/${newNum}`);
                };
            });
        }

        function formatDate(date) {
            if (!date || isNaN(date)) return '';
            const d = new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${day}/${month}/${year}`;
        }

        async function saveStudentRecord(data) {
            if (data.id) {
                return updateInDB('students', data);
            } else {
                delete data.id; // ensure it's undefined for auto-increment
                return addToDB('students', data);
            }
        }

        // --- EXPORT & SHARE ---
        function getExportOptions(docType) {
            const element = docType === 'Admission' ? previewAdmission : previewBursary;
            const fileName = `${docType}-${state.currentStudentData.refNo.replace('/', '-')}.pdf`;
            return {
                margin: 0,
                filename: fileName,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
        }

        function exportAsPDF(docType) {
            if (!state.currentStudentData) {
                showToast('No student data available. Please generate letters first.', 'error');
                return;
            }
            
            showToast('Generating PDF...', 'info');
            const element = docType === 'Admission' ? previewAdmission : previewBursary;
            
            // Check if element has content
            if (!element || !element.innerHTML.trim()) {
                showToast('No document content found. Please generate letters first.', 'error');
                return;
            }
            
            // Create a temporary element with single-page styling
            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'fixed';
            tempDiv.style.top = '0';
            tempDiv.style.left = '0';
            tempDiv.style.width = '21cm';
            tempDiv.style.height = '29.7cm';
            tempDiv.style.backgroundColor = '#ffffff';
            tempDiv.style.zIndex = '9999';
            tempDiv.style.padding = '1cm';
            tempDiv.style.margin = '0 auto';
            tempDiv.style.boxSizing = 'border-box';
            tempDiv.style.overflow = 'hidden';
            
            if (docType === 'Admission') {
                // For admission letters, get only the first page and apply single-page class
                const firstPage = element.querySelector('.page.A4:first-child');
                if (firstPage) {
                    const clonedPage = firstPage.cloneNode(true);
                    clonedPage.classList.add('single-page');
                    tempDiv.appendChild(clonedPage);
                }
            } else {
                // For bursary letters, get the entire element and apply single-page class
                const bursaryPage = element.querySelector('.page.A4');
                if (bursaryPage) {
                    const clonedPage = bursaryPage.cloneNode(true);
                    clonedPage.classList.add('single-page');
                    tempDiv.appendChild(clonedPage);
                }
            }
            
            // Append to body for rendering
            document.body.appendChild(tempDiv);
            
            // Wait for images and styles to load
            setTimeout(() => {
                // Check if html2canvas is available
                if (!window.html2canvas) {
                    if (document.body.contains(tempDiv)) {
                        document.body.removeChild(tempDiv);
                    }
                    showToast('HTML2Canvas library not loaded. Please refresh the page and try again.', 'error');
                    return;
                }
                
                // Use html2canvas to capture the content
                html2canvas(tempDiv, { 
                    scale: 2, 
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    
                    // Access jsPDF correctly with multiple fallback methods
                    let jsPDF;
                    if (window.jspdf && window.jspdf.jsPDF) {
                        jsPDF = window.jspdf.jsPDF;
                    } else if (window.jsPDF) {
                        jsPDF = window.jsPDF;
                    } else if (typeof window.jspdf === 'function') {
                        jsPDF = window.jspdf;
                    } else {
                        throw new Error('jsPDF library not loaded. Please refresh the page and try again.');
                    }
                    
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();

                    // Calculate scale to fit width and height
                    const imgWidth = canvas.width;
                    const imgHeight = canvas.height;
                    const ratio = Math.min(pageWidth / (imgWidth * 0.264583), pageHeight / (imgHeight * 0.264583));

                    // Calculate actual dimensions in mm
                    const finalWidth = (imgWidth * 0.264583) * ratio;
                    const finalHeight = (imgHeight * 0.264583) * ratio;

                    // Centering
                    const x = (pageWidth - finalWidth) / 2;
                    const y = (pageHeight - finalHeight) / 2;

                    pdf.addImage(imgData, 'PNG', x, y, finalWidth, finalHeight);
                    
                    const fileName = docType === 'Admission' ? 
                        `Admission_Letter_${state.currentStudentData.name.replace(/[^a-zA-Z0-9]/g, '_')}_${state.currentStudentData.refNo.replace('/', '-')}.pdf` :
                        `Bursary_Letter_${state.currentStudentData.name.replace(/[^a-zA-Z0-9]/g, '_')}_${state.currentStudentData.refNo.replace('/', '-')}.pdf`;
                    
                    pdf.save(fileName);
                    
                    // Clean up temporary element
                    if (document.body.contains(tempDiv)) {
                        document.body.removeChild(tempDiv);
                    }
                    showToast('PDF exported successfully!', 'success');
                }).catch((error) => {
                    console.error('PDF export error:', error);
                    if (document.body.contains(tempDiv)) {
                        document.body.removeChild(tempDiv);
                    }
                    showToast(`PDF export failed: ${error.message}. Please try again.`, 'error');
                });
            }, 1000); // Increased wait time for better rendering
        }

        async function printDocument(docType) {
            if (!state.currentStudentData) {
                showToast('No student data available. Please generate letters first.', 'error');
                return;
            }
            
            showToast('Generating PDF for printing...', 'info');
            let pdfUrl = null;

            try {
                const element = docType === 'Admission' ? previewAdmission : previewBursary;
                
                // Check if element has content
                if (!element || !element.innerHTML.trim()) {
                    showToast('No document content found. Please generate letters first.', 'error');
                    return;
                }
                
                // Create a temporary element with single-page styling
                const tempDiv = document.createElement('div');
                tempDiv.style.position = 'fixed';
                tempDiv.style.top = '0';
                tempDiv.style.left = '0';
                tempDiv.style.width = '210mm';
                tempDiv.style.height = '297mm';
                tempDiv.style.backgroundColor = '#ffffff';
                tempDiv.style.zIndex = '9999';
                tempDiv.style.padding = '10mm';
                tempDiv.style.margin = '0 auto';
                tempDiv.style.boxSizing = 'border-box';
                tempDiv.style.overflow = 'hidden';
                

                if (docType === 'Admission') {
                    // For admission letters, get only the first page and apply single-page class
                    const firstPage = element.querySelector('.page.A4:first-child');
                    if (firstPage) {
                        const clonedPage = firstPage.cloneNode(true);
                        clonedPage.classList.add('single-page');
                        tempDiv.appendChild(clonedPage);
                    }
                } else {
                    // For bursary letters, get the entire element and apply single-page class
                    const bursaryPage = element.querySelector('.page.A4');
                    if (bursaryPage) {
                        const clonedPage = bursaryPage.cloneNode(true);
                        clonedPage.classList.add('single-page');
                        tempDiv.appendChild(clonedPage);
                    }
                }
                
                // Append to body for rendering
                document.body.appendChild(tempDiv);
                
                // Wait for images and styles to load
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Check if html2canvas is available
                if (!window.html2canvas) {
                    if (document.body.contains(tempDiv)) {
                        document.body.removeChild(tempDiv);
                    }
                    throw new Error('HTML2Canvas library not loaded. Please refresh the page and try again.');
                }
                
                // Use html2canvas to capture the content
                const canvas = await html2canvas(tempDiv, { 
                    scale: 2, 
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff'
                });
                
                const imgData = canvas.toDataURL('image/png');
                
                // Access jsPDF correctly with multiple fallback methods
                let jsPDF;
                if (window.jspdf && window.jspdf.jsPDF) {
                    jsPDF = window.jspdf.jsPDF;
                } else if (window.jsPDF) {
                    jsPDF = window.jsPDF;
                } else if (typeof window.jspdf === 'function') {
                    jsPDF = window.jspdf;
                } else {
                    throw new Error('jsPDF library not loaded. Please refresh the page and try again.');
                }
                
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();

                // Calculate scale to fit width and height
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const ratio = Math.min(pageWidth / (imgWidth * 0.264583), pageHeight / (imgHeight * 0.264583));

                // Calculate actual dimensions in mm
                const finalWidth = (imgWidth * 0.264583) * ratio;
                const finalHeight = (imgHeight * 0.264583) * ratio;

                // Centering
                const x = (pageWidth - finalWidth) / 2;
                const y = (pageHeight - finalHeight) / 2;

                pdf.addImage(imgData, 'PNG', x, y, finalWidth, finalHeight);
                
                // Generate the PDF as a Blob
                const pdfBlob = pdf.output('blob');
                
                // Clean up temporary element
                if (document.body.contains(tempDiv)) {
                    document.body.removeChild(tempDiv);
                }
                
                // Create an Object URL from the Blob
                pdfUrl = URL.createObjectURL(pdfBlob);

                // Create a hidden iframe to hold the PDF
                const iframe = document.createElement('iframe');
                iframe.style.position = 'fixed';
                iframe.style.left = '-9999px';
                document.body.appendChild(iframe);

                // Set its source to the PDF data and print when loaded
                iframe.src = pdfUrl;
                iframe.onload = function() {
                    try {
                        iframe.contentWindow.focus();

                        iframe.contentWindow.onafterprint = () => {
                            if (document.body.contains(iframe)) {
                                document.body.removeChild(iframe);
                            }
                            URL.revokeObjectURL(pdfUrl);
                        };

                        iframe.contentWindow.print();
                        showToast('Print dialog opened.', 'success');
                    } catch (e) {
                        console.error('Print failed:', e);
                        showToast('Could not open print dialog. Please try downloading the PDF and printing it manually.', 'error');
                        if (document.body.contains(iframe)) {
                            document.body.removeChild(iframe);
                        }
                        URL.revokeObjectURL(pdfUrl);
                    }
                };
            } catch (error) {
                console.error('Error generating PDF for printing:', error);
                showToast(`Could not generate PDF for printing: ${error.message}`, 'error');
                if (pdfUrl) {
                    URL.revokeObjectURL(pdfUrl);
                }
                // Clean up temporary element if it exists
                const tempElements = document.querySelectorAll('div[style*="9999"]');
                tempElements.forEach(el => {
                    if (el.parentNode) {
                        el.parentNode.removeChild(el);
                    }
                });
            }
        }

        // PDF cache for synchronous sharing
        const pdfCache = {
            admission: null,
            bursary: null,
            lastStudentId: null,
            lastGenerated: null
        };

        // Generate and cache PDFs for sharing
        async function generatePDFsForSharing() {
            if (!state.currentStudentData) return;
            
            try {
                // Check if PDFs are already cached for this student
                if (pdfCache.lastStudentId === state.currentStudentData.id && 
                    pdfCache.admission && pdfCache.bursary && 
                    (Date.now() - pdfCache.lastGenerated) < 300000) { // 5 minutes cache
                    return; // Use existing cache
                }
                
                // Access jsPDF
                let jsPDF;
                if (window.jspdf && window.jspdf.jsPDF) {
                    jsPDF = window.jspdf.jsPDF;
                } else if (window.jsPDF) {
                    jsPDF = window.jsPDF;
                } else if (typeof window.jspdf === 'function') {
                    jsPDF = window.jspdf;
                } else {
                    throw new Error('jsPDF library not loaded');
                }
                
                console.log('Pre-generating PDFs for sharing...');
                
                // Generate and cache admission PDF
                if (previewAdmission && previewAdmission.innerHTML.trim()) {
                    pdfCache.admission = await generatePDFBlob(previewAdmission, 'admission', jsPDF);
                }
                
                // Generate and cache bursary PDF
                if (previewBursary && previewBursary.innerHTML.trim()) {
                    pdfCache.bursary = await generatePDFBlob(previewBursary, 'bursary', jsPDF);
                }
                
                pdfCache.lastStudentId = state.currentStudentData.id;
                pdfCache.lastGenerated = Date.now();
                
                console.log('PDFs cached successfully for sharing');
                
            } catch (error) {
                console.warn('Failed to pre-generate PDFs:', error);
                // Clear cache on error
                pdfCache.admission = null;
                pdfCache.bursary = null;
                pdfCache.lastStudentId = null;
            }
        }

        async function shareViaWhatsApp(docType) {
            if (!state.currentStudentData) {
                showToast('No student data available. Please generate letters first.', 'error');
                return;
            }

            // Check Web Share API support immediately while in user gesture context
            const canShare = navigator.canShare && navigator.share;
            if (!canShare) {
                showToast('Direct sharing not supported on this browser. Please use individual PDF download buttons instead.', 'warning');
                return;
            }

            // Test PDF sharing capability immediately
            try {
                const testBlob = new Blob(['%PDF-1.4 test'], { type: 'application/pdf' });
                const testFile = new File([testBlob], 'test.pdf', { type: 'application/pdf' });
                const testShare = { files: [testFile], title: 'Test', text: 'Test' };
                
                if (!navigator.canShare(testShare)) {
                    showToast('PDF file sharing not supported on this device. Please use individual PDF download buttons instead.', 'warning');
                    return;
                }
            } catch (e) {
                showToast('Direct sharing not available. Please use individual PDF download buttons instead.', 'warning');
                return;
            }

            try {
                const files = [];
                
                // Use cached PDFs if available, otherwise generate on-demand
                if (pdfCache.lastStudentId === state.currentStudentData.id && pdfCache.admission && pdfCache.bursary) {
                    // Use cached PDFs for synchronous sharing
                    const admissionFile = new File([pdfCache.admission], 'Admission Letter.pdf', { type: 'application/pdf' });
                    const bursaryFile = new File([pdfCache.bursary], 'Bursary.pdf', { type: 'application/pdf' });
                    files.push(admissionFile, bursaryFile);
                    
                    console.log('Using cached PDFs for immediate sharing');
                } else {
                    // Fallback: generate PDFs quickly but this might break user gesture
                    showToast('Generating documents quickly...', 'info');
                    
                    let jsPDF;
                    if (window.jspdf && window.jspdf.jsPDF) {
                        jsPDF = window.jspdf.jsPDF;
                    } else if (window.jsPDF) {
                        jsPDF = window.jsPDF;
                    } else if (typeof window.jspdf === 'function') {
                        jsPDF = window.jspdf;
                    } else {
                        throw new Error('jsPDF library not loaded. Please refresh the page and try again.');
                    }
                    
                    if (!previewAdmission || !previewAdmission.innerHTML.trim()) {
                        showToast('No admission letter content found. Please generate letters first.', 'error');
                        return;
                    }
                    if (!previewBursary || !previewBursary.innerHTML.trim()) {
                        showToast('No bursary letter content found. Please generate letters first.', 'error');
                        return;
                    }
                    
                    const admissionBlob = await generatePDFBlob(previewAdmission, 'admission', jsPDF);
                    const bursaryBlob = await generatePDFBlob(previewBursary, 'bursary', jsPDF);
                    
                    const admissionFile = new File([admissionBlob], 'Admission Letter.pdf', { type: 'application/pdf' });
                    const bursaryFile = new File([bursaryBlob], 'Bursary.pdf', { type: 'application/pdf' });
                    files.push(admissionFile, bursaryFile);
                }
                
                // Get fee structure if available
                const course = await getByIdFromDB('courses', state.currentStudentData.courseId);
                if (course && course.feeStructurePdf) {
                    try {
                        // Load fee structure from fees/ folder
                        const feeStructureBlob = await fetch(course.feeStructurePdf).then(res => res.blob());
                        const feeStructureFile = new File([feeStructureBlob], course.feeStructureFileName || 'Fees.pdf', { type: 'application/pdf' });
                        files.push(feeStructureFile);
                    } catch (feeError) {
                        console.warn('Could not load fee structure PDF from fees/ folder:', feeError);
                    }
                }

                // Create share data
                const shareData = {
                    files: files,
                    title: `Complete Documents for ${state.currentStudentData.name}`,
                    text: `Hello, here are the complete documents for ${state.currentStudentData.name} (Ref: ${state.currentStudentData.refNo}). Includes: Admission Letter, Bursary Letter${files.length > 2 ? ', and Fee Structure' : ''}.`,
                };

                // Share immediately
                console.log('Attempting direct sharing of', files.length, 'files via Web Share API');
                await navigator.share(shareData);
                showToast(`${files.length} document(s) shared successfully!`, 'success');
                
            } catch (error) {
                console.error('Direct sharing failed:', error);
                
                if (error.name === 'AbortError') {
                    showToast('Sharing cancelled by user.', 'info');
                } else if (error.message && error.message.includes('user gesture')) {
                    showToast('Direct sharing requires a direct button click. Please try clicking the share button again.', 'warning');
                } else {
                    showToast(`Direct sharing failed: ${error.message}. Please use individual PDF download buttons instead.`, 'error');
                }
                
                // Clean up any temporary elements that might be left
                const tempElements = document.querySelectorAll('div[style*="9999"]');
                tempElements.forEach(el => {
                    if (el.parentNode) {
                        el.parentNode.removeChild(el);
                    }
                });
            }
        }

        // Helper function to generate PDF blob more efficiently
        async function generatePDFBlob(previewElement, docType, jsPDF) {
            return new Promise(async (resolve, reject) => {
                try {
                    // Create temporary element
                    const tempDiv = document.createElement('div');
                    tempDiv.style.position = 'fixed';
                    tempDiv.style.top = '0';
                    tempDiv.style.left = '0';
                    tempDiv.style.width = '210mm';
                    tempDiv.style.height = '297mm';
                    tempDiv.style.backgroundColor = '#ffffff';
                    tempDiv.style.zIndex = '9999';
                    tempDiv.style.padding = '10mm';
                    tempDiv.style.margin = '0 auto';
                    tempDiv.style.boxSizing = 'border-box';
                    tempDiv.style.overflow = 'hidden';
                    
                    // Clone content
                    const pageSelector = docType === 'admission' ? '.page.A4:first-child' : '.page.A4';
                    const targetPage = previewElement.querySelector(pageSelector);
                    if (targetPage) {
                        const clonedPage = targetPage.cloneNode(true);
                        clonedPage.classList.add('single-page');
                        tempDiv.appendChild(clonedPage);
                    }
                    
                    document.body.appendChild(tempDiv);
                    
                    // Wait for rendering
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Check html2canvas availability
                    if (!window.html2canvas) {
                        throw new Error('HTML2Canvas library not loaded');
                    }
                    
                    // Generate canvas
                    const canvas = await html2canvas(tempDiv, {
                        scale: 2,
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: '#ffffff'
                    });
                    
                    // Create PDF
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    
                    const imgWidth = canvas.width;
                    const imgHeight = canvas.height;
                    const ratio = Math.min(pageWidth / (imgWidth * 0.264583), pageHeight / (imgHeight * 0.264583));
                    
                    const finalWidth = (imgWidth * 0.264583) * ratio;
                    const finalHeight = (imgHeight * 0.264583) * ratio;
                    
                    const x = (pageWidth - finalWidth) / 2;
                    const y = (pageHeight - finalHeight) / 2;
                    
                    pdf.addImage(imgData, 'PNG', x, y, finalWidth, finalHeight);
                    const blob = pdf.output('blob');
                    
                    // Cleanup
                    if (document.body.contains(tempDiv)) {
                        document.body.removeChild(tempDiv);
                    }
                    
                    resolve(blob);
                    
                } catch (error) {
                    // Cleanup on error
                    const tempElements = document.querySelectorAll('div[style*="9999"]');
                    tempElements.forEach(el => {
                        if (el.parentNode) {
                            el.parentNode.removeChild(el);
                        }
                    });
                    reject(error);
                }
            });
        }

        // --- STUDENT LIST ---
        async function loadStudentList() {
            const allStudents = await getAllFromDB('students');
            
            // Update campus indicator
            const campusDisplay = document.getElementById('currentCampusDisplay');
            if (campusDisplay && state.currentAdmin) {
                campusDisplay.textContent = state.currentAdmin.displayName;
                campusDisplay.style.color = 'var(--primary-color)';
                campusDisplay.style.fontWeight = 'bold';
            }
            
            // Filter students by current admin's campus FIRST
            const campusStudents = state.currentAdmin ? 
                allStudents.filter(s => s.campus === state.currentAdmin.type) : allStudents;
            
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
            const yearFilter = document.getElementById('studentYearFilter').value;

            const filteredStudents = campusStudents.filter(s => {
                const matchesSearch = s.name.toLowerCase().includes(searchTerm) || s.admNo.toLowerCase().includes(searchTerm);
                const matchesYear = !yearFilter || s.year == yearFilter;
                return matchesSearch && matchesYear;
            }).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            populateStudentTable(filteredStudents);
            populateYearFilter(campusStudents); // Use campus-filtered students for year filter
        }

        function populateStudentTable(students) {
            const tbody = document.getElementById('studentsTable').querySelector('tbody');
            tbody.innerHTML = '';
            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No students found.</td></tr>';
                return;
            }
            students.forEach(s => {
                const campusDisplay = s.campusName || (s.campus === 'west' ? 'West Campus' : s.campus === 'town' ? 'Town Campus' : 'Unknown');
                const row = `
                    <tr>
                        <td>${s.refNo}</td>
                        <td>${s.name}</td>
                        <td>${s.admNo}</td>
                        <td>${s.courseName}</td>
                        <td>${campusDisplay}</td>
                        <td>${formatDate(new Date(s.reportDate))}</td>
                        <td>${s.year}</td>
                        <td class="btn-group">
                            <button class="btn btn-sm btn-primary" onclick="app.viewStudent(${s.id})">View</button>
                            <button class="btn btn-sm btn-secondary" onclick="app.regenerateStudent(${s.id})">Regenerate / Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="app.deleteStudent(${s.id})">Delete</button>
                        </td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        function populateYearFilter(students) {
            const yearFilterEl = document.getElementById('studentYearFilter');
            const currentVal = yearFilterEl.value;
            // Only use years from the campus-filtered students
            const years = [...new Set(students.map(s => s.year))].sort((a, b) => b - a);
            yearFilterEl.innerHTML = '<option value="">All Years</option>';
            years.forEach(year => {
                yearFilterEl.innerHTML += `<option value="${year}">${year}</option>`;
            });
            yearFilterEl.value = currentVal;
        }

        async function viewStudent(id) {
            const student = await getByIdFromDB('students', id);
            if (student) {
                // Check if student belongs to current admin's campus
                if (state.currentAdmin && student.campus !== state.currentAdmin.type) {
                    showToast('Access denied: Student belongs to different campus.', 'error');
                    return;
                }
                
                state.currentStudentData = student;
                renderAdmissionPages(student);
                renderBursaryPage(student);
                applyTemplateStyle();
                
                // Pre-generate PDFs for sharing
                setTimeout(() => {
                    generatePDFsForSharing().catch(error => {
                        console.warn('Failed to pre-generate PDFs for sharing:', error);
                    });
                }, 1000);
                
                admissionActions.classList.remove('hidden');
                bursaryActions.classList.remove('hidden');
                navigateToView('viewGenerate');
                showToast(`Viewing record for ${student.name}`, 'success');
            }
        }

        async function regenerateStudent(id) {
            const student = await getByIdFromDB('students', id);
            if (student) {
                // Check if student belongs to current admin's campus
                if (state.currentAdmin && student.campus !== state.currentAdmin.type) {
                    showToast('Access denied: Student belongs to different campus.', 'error');
                    return;
                }
                
                // 1. Reset and populate the form with the student's text data
                resetGenerateForm();
                generateForm.id.value = student.id;
                generateForm.name.value = student.name;
                generateForm.admNo.value = student.admNo;
                generateForm.course.value = student.courseId;
                await handleCourseChange(); // To update the requirements field
                generateForm.reportDate.value = student.reportDate.split('T')[0];
                generateForm.feeBalance.value = student.feeBalance;
                generateForm.totalPerTerm.value = student.totalPerTerm;
                generateForm.template.value = student.template;
                generateForm.btnGenerate.textContent = 'Update Record';

                // 2. Create a temporary data object for the preview.
                //    Use the loaded student data, but overwrite images with the current app state.
                const previewData = {
                    ...student,
                    headerImg: state.headerImageDataUrl,
                    stampImg: state.stampImageDataUrl,
                    currentDate: formatDate(new Date()) // Use today's date for the preview
                };
                
                // 3. Set this as the current student data and render the previews
                state.currentStudentData = previewData;
                renderAdmissionPages(previewData);
                renderBursaryPage(previewData);
                applyTemplateStyle();
                
                // Pre-generate PDFs for sharing
                setTimeout(() => {
                    generatePDFsForSharing().catch(error => {
                        console.warn('Failed to pre-generate PDFs for sharing:', error);
                    });
                }, 1000);
                
                // 4. Show action buttons and navigate
                admissionActions.classList.remove('hidden');
                bursaryActions.classList.remove('hidden');
                navigateToView('viewGenerate');
                showToast(`Editing record for ${student.name}. Previews updated with current images.`, 'success');
            }
        }

        async function deleteStudent(id) {
            const student = await getByIdFromDB('students', id);
            if (student) {
                // Check if student belongs to current admin's campus
                if (state.currentAdmin && student.campus !== state.currentAdmin.type) {
                    showToast('Access denied: Student belongs to different campus.', 'error');
                    return;
                }
                
                if (confirm('Are you sure you want to delete this student record? This cannot be undone.')) {
                    await deleteFromDB('students', id);
                    showToast('Student record deleted.', 'success');
                    loadStudentList();
                }
            }
        }

        // --- ANALYSIS ---
        async function updateAnalysisCharts() {
            const students = await getAllFromDB('students');
            const courses = await getAllFromDB('courses');
            
            // Update analysis indicator
            const analysisDisplay = document.getElementById('analysisCampusDisplay');
            if (analysisDisplay && state.currentAdmin) {
                analysisDisplay.textContent = state.currentAdmin.displayName;
                analysisDisplay.style.color = 'var(--primary-color)';
                analysisDisplay.style.fontWeight = 'bold';
            }
            
            // Filter students by current admin's campus
            const campusStudents = state.currentAdmin ? 
                students.filter(s => s.campus === state.currentAdmin.type) : students;

            // Admissions per Year
            const admissionsByYear = campusStudents.reduce((acc, s) => {
                acc[s.year] = (acc[s.year] || 0) + 1;
                return acc;
            }, {});
            const yearChartTitle = state.currentAdmin ? 
                `${state.currentAdmin.displayName} - Admissions per Year` : 'Admissions per Year';
            renderChart('admissionsPerYearChart', 'bar', yearChartTitle, Object.keys(admissionsByYear), Object.values(admissionsByYear));

            // Admissions by Course
            const admissionsByCourse = campusStudents.reduce((acc, s) => {
                const course = courses.find(c => c.id === s.courseId);
                const courseName = course ? course.name : 'Unknown Course';
                acc[courseName] = (acc[courseName] || 0) + 1;
                return acc;
            }, {});
            const courseChartTitle = state.currentAdmin ? 
                `${state.currentAdmin.displayName} - Admissions by Course` : 'Admissions by Course';
            renderChart('admissionsByDeptChart', 'pie', courseChartTitle, Object.keys(admissionsByCourse), Object.values(admissionsByCourse));
        }

        function renderChart(canvasId, type, label, labels, data) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (state.charts[canvasId]) {
                state.charts[canvasId].destroy();
            }
            
            const gradientColors = [
                'rgba(102, 126, 234, 0.8)',
                'rgba(240, 147, 251, 0.8)',
                'rgba(78, 205, 196, 0.8)',
                'rgba(255, 107, 107, 0.8)',
                'rgba(252, 227, 138, 0.8)'
            ];
            
            state.charts[canvasId] = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: type === 'pie' ? gradientColors : 'rgba(102, 126, 234, 0.8)',
                        borderColor: type === 'pie' ? gradientColors.map(c => c.replace('0.8', '1')) : 'rgba(102, 126, 234, 1)',
                        borderWidth: 2,
                        borderRadius: type === 'bar' ? 8 : 0,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                font: {
                                    family: 'Inter, sans-serif',
                                    size: 12
                                },
                                color: '#334155'
                            }
                        }
                    },
                    scales: type === 'bar' ? {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#e2e8f0'
                            },
                            ticks: {
                                font: {
                                    family: 'Inter, sans-serif'
                                },
                                color: '#64748b'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    family: 'Inter, sans-serif'
                                },
                                color: '#64748b'
                            }
                        }
                    } : {}
                }
            });
        }

        // --- DASHBOARD ---
        async function updateDashboard() {
            const students = await getAllFromDB('students');
            const courses = await getAllFromDB('courses');
            
            // Filter students by current admin's campus
            const campusStudents = state.currentAdmin ? 
                students.filter(s => s.campus === state.currentAdmin.type) : students;
            
            const totalStudents = campusStudents.length;
            const totalCourses = courses.length;
            const coursesWithFeeStructure = courses.filter(c => c.feeStructurePdf).length;
            
            const campusInfo = state.currentAdmin ? 
                `<h3 style="color: var(--primary-color); margin-bottom: 1rem;">${state.currentAdmin.displayName} Dashboard</h3>` : 
                '';

            const dashboardContent = `
                <div class="card">
                    <h2 class="card-header">System Overview</h2>
                    ${campusInfo}
                    <div class="grid-3">
                        <div class="card"><h3>${totalStudents}</h3><p>${state.currentAdmin ? 'Campus Students' : 'Total Students'}</p></div>
                        <div class="card"><h3>${totalCourses}</h3><p>Total Courses</p></div>
                        <div class="card"><h3>${coursesWithFeeStructure}</h3><p>Courses with Fee Structure</p></div>
                    </div>
                </div>
            `;
            document.getElementById('viewDashboard').innerHTML = dashboardContent;
        }

        // --- PERMANENT STAMP & HEADER LOADING ---
        async function loadPermanentStamp() {
            try {
                // Convert stamp.png to base64 for permanent storage
                const response = await fetch('./stamp.png');
                if (response.ok) {
                    const blob = await response.blob();
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        state.stampImageDataUrl = e.target.result;
                        // Save permanently to database
                        await updateInDB('settings', { key: 'stampImageDataUrl', value: e.target.result });
                        // Update preview
                        const stampPreview = document.getElementById('stampPreview');
                        if (stampPreview) {
                            stampPreview.src = state.stampImageDataUrl;
                            stampPreview.classList.remove('hidden');
                        }
                        console.log('Permanent stamp loaded successfully');
                    };
                    reader.readAsDataURL(blob);
                } else {
                    console.warn('stamp.png not found, using default stamp handling');
                }
            } catch (error) {
                console.warn('Could not load permanent stamp:', error);
            }
        }

        async function loadPermanentHeader() {
            try {
                // Convert image.png to base64 for permanent storage
                const response = await fetch('./image.png');
                if (response.ok) {
                    const blob = await response.blob();
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        state.headerImageDataUrl = e.target.result;
                        // Save permanently to database
                        await updateInDB('settings', { key: 'headerImageDataUrl', value: e.target.result });
                        // Update preview
                        const headerPreview = document.getElementById('headerPreview');
                        if (headerPreview) {
                            headerPreview.src = state.headerImageDataUrl;
                            headerPreview.classList.remove('hidden');
                        }
                        console.log('Permanent header loaded successfully');
                    };
                    reader.readAsDataURL(blob);
                } else {
                    console.warn('image.png not found, using default header handling');
                }
            } catch (error) {
                console.warn('Could not load permanent header:', error);
            }
        }
        async function loadPersistedSettings() {
            try {
                // Header image is now loaded permanently, just check if it's in settings
                const headerImgSetting = await getFromDBByKey('settings', 'headerImageDataUrl');
                if (headerImgSetting && headerImgSetting.value) {
                    state.headerImageDataUrl = headerImgSetting.value;
                    const headerPreview = document.getElementById('headerPreview');
                    if (headerPreview) {
                        headerPreview.src = state.headerImageDataUrl;
                        headerPreview.classList.remove('hidden');
                    }
                }
                
                // Stamp is loaded permanently, just check if it's in settings
                const stampImgSetting = await getFromDBByKey('settings', 'stampImageDataUrl');
                if (stampImgSetting && stampImgSetting.value) {
                    state.stampImageDataUrl = stampImgSetting.value;
                    const stampPreview = document.getElementById('stampPreview');
                    if (stampPreview) {
                        stampPreview.src = state.stampImageDataUrl;
                        stampPreview.classList.remove('hidden');
                    }
                }
                
                if (headerImgSetting || stampImgSetting) {
                    showToast('Loaded permanent header and stamp images.', 'success');
                }
            } catch (e) {
                console.warn("Could not load persisted settings.", e);
            }
        }

        // --- FEE STRUCTURE MANAGEMENT ---
        async function loadFeeStructureFiles() {
            const feeStructureSelect = document.getElementById('courseFeeStructureSelect');
            if (!feeStructureSelect) return;
            
            // Clear existing options except the first one
            feeStructureSelect.innerHTML = '<option value="">Select a fee structure PDF...</option>';
            
            // List of fee structure files available in the fees/ folder
            const feeStructureFiles = [
                'Business course .pdf',
                'CamScanner 09-04-2025 15.55 (1).pdf',
                'beauty.pdf',
                'community health .pdf',
                'counseling psychology .pdf',
                'health services support .pdf',
                'lab technology .pdf',
                'medical lab.pdf',
                'medical laboratory .pdf',
                'opthopedic.pdf',
                'peri.pdf'
            ];
            
            // Add options for each file
            feeStructureFiles.forEach(fileName => {
                const option = document.createElement('option');
                option.value = fileName;
                option.textContent = fileName;
                feeStructureSelect.appendChild(option);
            });
        }

        // --- SETTINGS ---
        async function loadCoursesAndDepartments() {
            const courses = await getAllFromDB('courses');

            // Populate course dropdown in generate form
            const courseSelect = generateForm.course;
            courseSelect.innerHTML = '<option value="">Select Course</option>';
            courses.forEach(c => courseSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`);

            // Populate course table
            populateCourseTable(courses);
        }

        function populateCourseTable(courses) {
            const tbody = document.getElementById('courseTable').querySelector('tbody');
            tbody.innerHTML = '';
            if (courses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">No courses found.</td></tr>';
                return;
            }
            courses.forEach(c => {
                const feeStructureStatus = c.feeStructurePdf ? 
                    '<span style="color: green;">✓ Uploaded</span>' : 
                    '<span style="color: red;">✗ Not uploaded</span>';
                tbody.innerHTML += `
                    <tr>
                        <td>${c.name}</td>
                        <td>${feeStructureStatus}</td>
                        <td class="btn-group">
                            <button class="btn btn-sm btn-secondary" data-id="${c.id}" data-action="edit">Edit</button>
                            <button class="btn btn-sm btn-danger" data-id="${c.id}" data-action="delete">Delete</button>
                            ${c.feeStructurePdf ? `<button class="btn btn-sm btn-success" data-id="${c.id}" data-action="download">Download PDF</button>` : ''}
                        </td>
                    </tr>`;
            });
        }

        async function handleAddCourse(e) {
            e.preventDefault();
            const name = document.getElementById('courseName').value.trim();
            const feeStructureFileName = document.getElementById('courseFeeStructureSelect').value;
            
            if (!name) {
                showToast('Course name is required.', 'error');
                return;
            }
            
            const editingId = document.getElementById('editingCourseId').value;
            
            // For new courses, fee structure is required
            if (!editingId && !feeStructureFileName) {
                showToast('Fee structure PDF is required for new courses.', 'error');
                return;
            }

            const courseData = { name };
            if (feeStructureFileName) {
                // Store the filename to reference files from fees/ folder
                courseData.feeStructureFileName = feeStructureFileName;
                courseData.feeStructurePdf = `fees/${feeStructureFileName}`; // Path to fee structure in fees folder
            }

            try {
                if (editingId) {
                    courseData.id = parseInt(editingId);
                    // If editing and no new file selected, keep existing file
                    if (!feeStructureFileName) {
                        const existingCourse = await getByIdFromDB('courses', courseData.id);
                        courseData.feeStructurePdf = existingCourse.feeStructurePdf;
                        courseData.feeStructureFileName = existingCourse.feeStructureFileName;
                    }
                    await updateInDB('courses', courseData);
                    showToast('Course updated.', 'success');
                } else {
                    await addToDB('courses', courseData);
                    showToast('Course added with fee structure.', 'success');
                }
                resetCourseForm();
                loadCoursesAndDepartments();
            } catch (error) {
                console.error('Error saving course:', error);
                showToast('Course name must be unique.', 'error');
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function resetCourseForm() {
            document.getElementById('courseForm').reset();
            document.getElementById('editingCourseId').value = '';
            const submitBtn = document.querySelector('#courseForm button[type="submit"]');
            submitBtn.textContent = 'Add Course';
            submitBtn.classList.remove('btn-success');
            submitBtn.classList.add('btn-primary');
            document.getElementById('cancelCourseEditBtn').classList.add('hidden');
            
            // Reset fee structure selection requirement
            const feeStructureSelect = document.getElementById('courseFeeStructureSelect');
            feeStructureSelect.required = true;
        }

        async function handleEditCourse(id) {
            const course = await getByIdFromDB('courses', id);
            if (course) {
                document.getElementById('editingCourseId').value = course.id;
                document.getElementById('courseName').value = course.name;
                
                // Make fee structure selection optional for editing and set current value
                const feeStructureSelect = document.getElementById('courseFeeStructureSelect');
                feeStructureSelect.required = false;
                if (course.feeStructureFileName) {
                    feeStructureSelect.value = course.feeStructureFileName;
                }
                
                const submitBtn = document.querySelector('#courseForm button[type="submit"]');
                submitBtn.textContent = 'Update Course';
                submitBtn.classList.remove('btn-primary');
                submitBtn.classList.add('btn-success');
                document.getElementById('cancelCourseEditBtn').classList.remove('hidden');
            }
        }

        async function downloadFeeStructure(courseId) {
            const course = await getByIdFromDB('courses', courseId);
            if (course && course.feeStructurePdf) {
                const link = document.createElement('a');
                link.href = course.feeStructurePdf;
                link.download = course.feeStructureFileName || `${course.name}_fee_structure.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        async function handleCourseTableClick(e) {
            if (e.target.tagName === 'BUTTON' && e.target.dataset.id) {
                const id = parseInt(e.target.dataset.id);
                const action = e.target.dataset.action;

                if (action === 'edit') {
                    handleEditCourse(id);
                } else if (action === 'delete' && confirm('Are you sure you want to delete this course? This might affect existing student records.')) {
                    await deleteFromDB('courses', id);
                    showToast('Course deleted.', 'success');
                    loadCoursesAndDepartments();
                } else if (action === 'download') {
                    downloadFeeStructure(id);
                }
            }
        }

        // --- BACKUP & RESTORE ---
        async function backupAllData() {
            const allStudents = await getAllFromDB('students');
            
            // Filter students by current admin's campus for backup
            const campusStudents = state.currentAdmin ? 
                allStudents.filter(s => s.campus === state.currentAdmin.type) : allStudents;
            
            const data = {
                students: campusStudents,
                courses: await getAllFromDB('courses'),
                settings: await getAllFromDB('settings'),
                campus: state.currentAdmin ? state.currentAdmin.type : 'all'
            };
            
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            const campusPrefix = state.currentAdmin ? `${state.currentAdmin.type}-campus-` : '';
            a.download = `eavi-${campusPrefix}backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            const studentCount = campusStudents.length;
            const campusName = state.currentAdmin ? state.currentAdmin.displayName : 'System';
            showToast(`${campusName} backup created with ${studentCount} students.`, 'success');
        }

        function handleRestore() {
            const file = document.getElementById('restoreFile').files[0];
            if (!file) return;
            if (!confirm('WARNING: This will overwrite all existing data. Are you sure you want to proceed?')) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.students || !data.courses ) {
                        throw new Error('Invalid backup file format.');
                    }

                    const allStores = ['students', 'courses', 'settings'];
                    const tx = state.db.transaction(allStores, 'readwrite');

                    // Clear existing data
                    for (const storeName of allStores) {
                        const store = tx.objectStore(storeName);
                        await new Promise(resolve => store.clear().onsuccess = resolve);
                    }

                    // Add new data
                    for (const storeName of allStores) {
                        if (data[storeName]) {
                            const store = tx.objectStore(storeName);
                            for (const item of data[storeName]) {
                                if (item.id && ['students', 'courses'].includes(storeName)) {
                                    delete item.id;
                                }
                                await new Promise(resolve => store.add(item).onsuccess = resolve);
                            }
                        }
                    }

                    await new Promise(resolve => tx.oncomplete = resolve);

                    showToast('Data restored successfully. Reloading application...', 'success');
                    setTimeout(() => window.location.reload(), 2000);

                } catch (error) {
                    console.error('Restore error:', error);
                    showToast(`Restore failed: ${error.message}`, 'error');
                }
            };
            reader.readAsText(file);
        }

        async function handleClearAllData() {
            const confirmation = prompt("This will permanently delete ALL data, including students, courses, and saved images. This action cannot be undone.\n\nTo confirm, please type 'DELETE' in the box below.");
            if (confirmation === 'DELETE') {
                try {
                    showToast('Clearing all data...', 'info');
                    const allStores = ['students', 'courses', 'settings'];
                    const tx = state.db.transaction(allStores, 'readwrite');

                    for (const storeName of allStores) {
                        const store = tx.objectStore(storeName);
                        await new Promise((resolve, reject) => {
                            const request = store.clear();
                            request.onsuccess = resolve;
                            request.onerror = reject;
                        });
                    }

                    await new Promise(resolve => tx.oncomplete = resolve);

                    showToast('All application data has been cleared. Reloading...', 'success');
                    setTimeout(() => {
                        sessionStorage.clear();
                        window.location.reload();
                    }, 2000);
                } catch (error) {
                    console.error('Error clearing data:', error);
                    showToast('Failed to clear data.', 'error');
                }
            } else {
                showToast('Clear data operation cancelled.', 'info');
            }
        }

        // --- UTILITIES ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 4000);
        }

        // --- MANUAL COURSE ADDITION (for existing databases) ---
        async function addNewCoursesToExistingDB() {
            if (!state.db) {
                showToast('Database not initialized', 'error');
                return;
            }

            const newCourses = [
                // Medical and Healthcare Courses
                'Peri-operative Theater Technology',
                'Orthopaedic and Trauma Medicine',
                'Dental Assistant',
                'Phlebotomy',
                'Certified Nurse Assistant (CNA)',
                'Morgue Attendant',
                'Basic Life Support (BLS)',
                'Mortuary Science',
                'Home Care Nursing',
                'Health Services Support',
                'Health Care Assistant',
                'Individual Support',
                'Caregiver',
                'Nurse Aide',
                'Patient Attendant',
                'Midwifery',
                'Community Health Assistant',
                'Public Health',
                'Nutrition and Dietetics',
                'Medical Engineering and Laboratory Technology',
                'Community Health and Social Work',
                'HIV/AIDS Management',
                'HIV/AIDS Testing & Counseling (HTC)',
                'First Aid',
                
                // Social Services and Care
                'Child Care and Protection',
                'Social Work and Nurse Aide',
                'Community Development and Social Work',
                'Gender and Development Studies',
                'Counseling',
                'Guidance and Counseling Skills Development',
                'Counseling Psychology',
                'Conflict Management and Peace Building',
                
                // Beauty and Fashion
                'Hairdressing and Beauty Therapy',
                'Fashion and Design',
                'Garment Making',
                
                // Administrative and Office Skills
                'Secretarial',
                'Health Records Management with ICT',
                'Computer Packages / IT / ICT / Information Science',
                'Public Administration and Relations',
                'Customer Care / Front Office Management',
                
                // Education and Training
                'Teacher Education',
                'Leadership Skills Development',
                'Training of Trainers (TOT)',
                
                // Engineering and Technical
                'Security Management',
                'Electrical Engineering, Civil / Building / Survey',
                'Water Engineering / Plumbing, Mechanical / Automotive',
                
                // Hospitality and Food Services
                'Catering / Food and Beverage Management',
                'Culinary Arts',
                'Hotel and Hospitality Management',
                'Tourism Management',
                
                // Business and Management
                'Store Keeping',
                'Purchasing & Supply Management',
                'NGO Management',
                'Logistics and Procurement Management',
                'Human Resource Management (HRM)',
                'Business Administration and Management',
                'Finance & Banking',
                'Sales and Marketing',
                'Entrepreneurship',
                'Financial Management for NGOs',
                
                // Specialized Skills
                'General Agriculture',
                'Criminology',
                'Nutrition Management Skills',
                'Monitoring and Evaluation of Projects',
                'Disaster Management'
            ];

            try {
                // Get existing courses to avoid duplicates
                const existingCourses = await getAllFromDB('courses');
                const existingNames = existingCourses.map(c => c.name.toLowerCase());
                
                let addedCount = 0;
                for (const courseName of newCourses) {
                    if (!existingNames.includes(courseName.toLowerCase())) {
                        await addToDB('courses', { name: courseName, feeStructurePdf: null });
                        addedCount++;
                    }
                }
                
                if (addedCount > 0) {
                    showToast(`Successfully added ${addedCount} new courses!`, 'success');
                    await loadCoursesAndDepartments(); // Refresh the course list
                } else {
                    showToast('All courses already exist in the database.', 'info');
                }
            } catch (error) {
                console.error('Error adding courses:', error);
                showToast('Error adding courses to database.', 'error');
            }
        }

        // --- GLOBAL ACCESS ---
        // Expose functions needed by inline onclick handlers
        window.app = {
            viewStudent,
            regenerateStudent,
            deleteStudent
        };

        // --- START THE APP ---
        init();
    });
    </script>
</body>
</html>